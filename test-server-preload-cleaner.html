<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Nettoyage Preloads Serveur</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 5px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üß™ Test Nettoyage Preloads au Niveau Serveur</h1>
    
    <div class="test-section info">
        <h3>üìã Instructions</h3>
        <p>1. Ouvrez la console du navigateur (F12)</p>
        <p>2. Rechargez cette page</p>
        <p>3. V√©rifiez les messages de nettoyage des preloads</p>
        <p>4. V√©rifiez qu'il n'y a plus d'avertissements de preload</p>
        <p>5. V√©rifiez que les erreurs 404 pour les polices ont disparu</p>
    </div>

    <div class="test-section">
        <h3>üîç V√©rification des Preloads</h3>
        <button onclick="checkPreloads()">V√©rifier les Preloads</button>
        <div id="preload-results"></div>
    </div>

    <div class="test-section">
        <h3>üìä Logs de Nettoyage</h3>
        <div id="cleanup-logs"></div>
    </div>

    <div class="test-section">
        <h3>üåê Test de Requ√™te Serveur</h3>
        <button onclick="testServerResponse()">Tester la R√©ponse Serveur</button>
        <div id="server-results"></div>
    </div>

    <script>
        // Capturer les logs de nettoyage
        const originalLog = console.log;
        const cleanupLogs = [];
        
        console.log = function(...args) {
            if (args[0] && (args[0].includes('üóëÔ∏è') || args[0].includes('üßπ') || args[0].includes('‚úÖ'))) {
                cleanupLogs.push(args.join(' '));
                updateCleanupLogs();
            }
            originalLog.apply(console, args);
        };

        function updateCleanupLogs() {
            const logsDiv = document.getElementById('cleanup-logs');
            logsDiv.innerHTML = cleanupLogs.map(log => `<div class="log">${log}</div>`).join('');
        }

        function checkPreloads() {
            const resultsDiv = document.getElementById('preload-results');
            
            // V√©rifier les preloads de polices
            const fontPreloads = document.querySelectorAll('link[rel="preload"][as="font"]');
            const geistFonts = Array.from(fontPreloads).filter(link => 
                link.getAttribute('href') && link.getAttribute('href').includes('geist')
            );
            
            // V√©rifier les preloads d'images
            const imagePreloads = document.querySelectorAll('link[rel="preload"][as="image"]');
            const ogImages = Array.from(imagePreloads).filter(link => 
                link.getAttribute('href') && link.getAttribute('href').includes('og-image')
            );
            
            let html = '<h4>R√©sultats de la V√©rification:</h4>';
            
            if (fontPreloads.length === 0) {
                html += '<div class="success">‚úÖ Aucun preload de police trouv√©</div>';
            } else {
                html += `<div class="error">‚ùå ${fontPreloads.length} preload(s) de police trouv√©(s)</div>`;
                fontPreloads.forEach(link => {
                    html += `<div style="margin-left: 20px;">- ${link.getAttribute('href')}</div>`;
                });
            }
            
            if (geistFonts.length === 0) {
                html += '<div class="success">‚úÖ Aucun preload de police Geist trouv√©</div>';
            } else {
                html += `<div class="error">‚ùå ${geistFonts.length} preload(s) de police Geist trouv√©(s)</div>`;
                geistFonts.forEach(link => {
                    html += `<div style="margin-left: 20px;">- ${link.getAttribute('href')}</div>`;
                });
            }
            
            if (imagePreloads.length === 0) {
                html += '<div class="success">‚úÖ Aucun preload d\'image trouv√©</div>';
            } else {
                html += `<div class="error">‚ùå ${imagePreloads.length} preload(s) d\'image trouv√©(s)</div>`;
                imagePreloads.forEach(link => {
                    html += `<div style="margin-left: 20px;">- ${link.getAttribute('href')}</div>`;
                });
            }
            
            if (ogImages.length === 0) {
                html += '<div class="success">‚úÖ Aucun preload d\'image og-image trouv√©</div>';
            } else {
                html += `<div class="error">‚ùå ${ogImages.length} preload(s) d\'image og-image trouv√©(s)</div>`;
                ogImages.forEach(link => {
                    html += `<div style="margin-left: 20px;">- ${link.getAttribute('href')}</div>`;
                });
            }
            
            resultsDiv.innerHTML = html;
        }

        async function testServerResponse() {
            const resultsDiv = document.getElementById('server-results');
            resultsDiv.innerHTML = '<div class="info">üîÑ Test de la r√©ponse serveur en cours...</div>';
            
            try {
                const response = await fetch('/encours', {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'
                    }
                });
                
                const html = await response.text();
                
                // V√©rifier si les preloads sont pr√©sents dans le HTML brut
                const geistPreloads = html.match(/<link[^>]*rel="preload"[^>]*as="font"[^>]*href="[^"]*geist[^"]*"[^>]*>/gi);
                const ogImagePreloads = html.match(/<link[^>]*rel="preload"[^>]*as="image"[^>]*href="[^"]*og-image[^"]*"[^>]*>/gi);
                const woff2Preloads = html.match(/<link[^>]*rel="preload"[^>]*as="font"[^>]*href="[^"]*\.woff2[^"]*"[^>]*>/gi);
                
                let html_result = '<h4>R√©sultats du Test Serveur:</h4>';
                
                if (geistPreloads && geistPreloads.length > 0) {
                    html_result += `<div class="error">‚ùå ${geistPreloads.length} preload(s) de police Geist trouv√©(s) dans le HTML serveur</div>`;
                    geistPreloads.forEach(preload => {
                        html_result += `<div style="margin-left: 20px; font-size: 12px;">${preload}</div>`;
                    });
                } else {
                    html_result += '<div class="success">‚úÖ Aucun preload de police Geist dans le HTML serveur</div>';
                }
                
                if (ogImagePreloads && ogImagePreloads.length > 0) {
                    html_result += `<div class="error">‚ùå ${ogImagePreloads.length} preload(s) d\'image og-image trouv√©(s) dans le HTML serveur</div>`;
                    ogImagePreloads.forEach(preload => {
                        html_result += `<div style="margin-left: 20px; font-size: 12px;">${preload}</div>`;
                    });
                } else {
                    html_result += '<div class="success">‚úÖ Aucun preload d\'image og-image dans le HTML serveur</div>';
                }
                
                if (woff2Preloads && woff2Preloads.length > 0) {
                    html_result += `<div class="error">‚ùå ${woff2Preloads.length} preload(s) de police woff2 trouv√©(s) dans le HTML serveur</div>`;
                    woff2Preloads.forEach(preload => {
                        html_result += `<div style="margin-left: 20px; font-size: 12px;">${preload}</div>`;
                    });
                } else {
                    html_result += '<div class="success">‚úÖ Aucun preload de police woff2 dans le HTML serveur</div>';
                }
                
                // V√©rifier le header X-Preload-Cleaner
                const preloadCleanerHeader = response.headers.get('X-Preload-Cleaner');
                if (preloadCleanerHeader) {
                    html_result += '<div class="success">‚úÖ Header X-Preload-Cleaner d√©tect√©: ' + preloadCleanerHeader + '</div>';
                } else {
                    html_result += '<div class="error">‚ùå Header X-Preload-Cleaner non d√©tect√©</div>';
                }
                
                resultsDiv.innerHTML = html_result;
                
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">‚ùå Erreur lors du test serveur: ' + error.message + '</div>';
            }
        }

        // V√©rifier automatiquement au chargement
        window.addEventListener('load', () => {
            setTimeout(checkPreloads, 1000);
        });
    </script>
</body>
</html>
