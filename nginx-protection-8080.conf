# Configuration Nginx pour la protection des sous-domaines
# Port 8080 pour éviter le conflit avec le NAS

server {
    listen 8080;
    server_name librespeed.iahome.fr meeting-reports.iahome.fr whisper.iahome.fr 
                comfyui.iahome.fr stablediffusion.iahome.fr qrcodes.iahome.fr 
                psitransfer.iahome.fr metube.iahome.fr pdf.iahome.fr;

    # Page de redirection par défaut
    location / {
        root /var/www/html;
        try_files /subdomain-redirect.html =404;
    }

    # Autoriser l'accès avec token
    location ~* \?.*token=.* {
        # Rediriger vers le service réel
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Autoriser l'accès depuis iahome.fr
    location / {
        if ($http_referer ~* iahome\.fr) {
            proxy_pass http://localhost:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Sinon, servir la page de redirection
        root /var/www/html;
        try_files /subdomain-redirect.html =404;
    }
}
