# Configuration Traefik pour la sécurisation des applications iahome
# Tous les sous-domaines sont maintenant gérés par le tunnel Cloudflare
# Traefik ne gère que l'application principale et les redirections internes

http:
  middlewares:
    
    # Middleware de redirection sécurisée pour MeTube
    metube-secure-redirect:
      redirectRegex:
        regex: "^https://metube\\.iahome\\.fr(.*)$"
        replacement: "https://iahome.fr/redirect-metube$1"
        permanent: false
    
    # Middleware de redirection sécurisée pour PDF
    pdf-secure-redirect:
      redirectRegex:
        regex: "^https://pdf\\.iahome\\.fr(.*)$"
        replacement: "https://iahome.fr/api/redirect-pdf$1"
        permanent: false
    
    # Middleware de redirection sécurisée pour PsiTransfer
    psitransfer-secure-redirect:
      redirectRegex:
        regex: "^https://psitransfer\\.iahome\\.fr(.*)$"
        replacement: "https://iahome.fr/api/redirect-psitransfer$1"
        permanent: false
    
    # Middleware de redirection sécurisée pour QR Codes (DÉSACTIVÉ - utilise qrcodes-cloudflare.yml)
    # qrcodes-secure-redirect:
    #   redirectRegex:
    #     regex: "^https://qrcodes\\.iahome\\.fr(.*)$"
    #     replacement: "https://iahome.fr/api/redirect-qrcodes$1"
    #     permanent: false
    
    # Middleware de redirection sécurisée pour Stable Diffusion
    stablediffusion-secure-redirect:
      redirectRegex:
        regex: "^https://stablediffusion\\.iahome\\.fr(.*)$"
        replacement: "https://iahome.fr/api/redirect-stablediffusion$1"
        permanent: false
    
    # Middleware de redirection sécurisée pour Ruined Fooocus
    ruinedfooocus-secure-redirect:
      redirectRegex:
        regex: "^https://ruinedfooocus\\.iahome\\.fr(.*)$"
        replacement: "https://iahome.fr/api/redirect-ruinedfooocus$1"
        permanent: false
    
    # Middleware de redirection sécurisée pour Cog Studio
    cogstudio-secure-redirect:
      redirectRegex:
        regex: "^https://cogstudio\\.iahome\\.fr(.*)$"
        replacement: "https://iahome.fr/api/redirect-cogstudio$1"
        permanent: false
    

  routers:

    # MeTube - Redirection sécurisée
    metube-secure:
      rule: "Host(`metube.iahome.fr`)"
      entryPoints: ["websecure"]
      service: metube-redirect-service
      middlewares: ["metube-secure-redirect", "security-headers@file", "compress@file"]
      tls: {}
      priority: 100

    # PDF - Redirection sécurisée
    pdf-secure:
      rule: "Host(`pdf.iahome.fr`)"
      entryPoints: ["websecure"]
      service: pdf-redirect-service
      middlewares: ["pdf-secure-redirect", "security-headers@file", "compress@file"]
      tls: {}
      priority: 100

    # PsiTransfer - Redirection sécurisée
    psitransfer-secure:
      rule: "Host(`psitransfer.iahome.fr`)"
      entryPoints: ["websecure"]
      service: psitransfer-redirect-service
      middlewares: ["psitransfer-secure-redirect", "security-headers@file", "compress@file"]
      tls: {}
      priority: 100

    # QR Codes - Redirection sécurisée (DÉSACTIVÉE - utilise qrcodes-cloudflare.yml)
    # qrcodes-secure:
    #   rule: "Host(`qrcodes.iahome.fr`)"
    #   entryPoints: ["websecure"]
    #   service: qrcodes-redirect-service
    #   middlewares: ["qrcodes-secure-redirect", "security-headers@file", "compress@file"]
    #   tls: {}
    #   priority: 100


    # Stable Diffusion - Redirection sécurisée
    stablediffusion-secure:
      rule: "Host(`stablediffusion.iahome.fr`)"
      entryPoints: ["websecure"]
      service: stablediffusion-redirect-service
      middlewares: ["stablediffusion-secure-redirect", "security-headers@file", "compress@file"]
      tls: {}
      priority: 100

    # Ruined Fooocus - Redirection sécurisée
    ruinedfooocus-secure:
      rule: "Host(`ruinedfooocus.iahome.fr`)"
      entryPoints: ["websecure"]
      service: ruinedfooocus-redirect-service
      middlewares: ["ruinedfooocus-secure-redirect", "security-headers@file", "compress@file"]
      tls: {}
      priority: 100


    # ComfyUI - Géré directement par le tunnel Cloudflare

    # Cog Studio - Redirection sécurisée
    cogstudio-secure:
      rule: "Host(`cogstudio.iahome.fr`)"
      entryPoints: ["websecure"]
      service: cogstudio-redirect-service
      middlewares: ["cogstudio-secure-redirect", "security-headers@file", "compress@file"]
      tls: {}
      priority: 100


  services:
    # Services de redirection vers l'application iahome

    metube-redirect-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

    pdf-redirect-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

    psitransfer-redirect-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

    # qrcodes-redirect-service (DÉSACTIVÉ - utilise qrcodes-cloudflare.yml directement)
    # qrcodes-redirect-service:
    #   loadBalancer:
    #     servers:
    #       - url: "http://iahome-app:3000"
    #     passHostHeader: true


    stablediffusion-redirect-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

    ruinedfooocus-redirect-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

    # ComfyUI - Géré directement par le tunnel Cloudflare

    cogstudio-redirect-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

