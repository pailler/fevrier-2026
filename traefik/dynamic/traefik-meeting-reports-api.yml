# Configuration Traefik pour l'API Meeting Reports Generator
# Placez ce fichier dans votre r√©pertoire traefik/dynamic/

http:
  routers:
    meeting-reports-api:
      rule: "Host(`meeting-reports.iahome.fr`) && PathPrefix(`/api`)"
      service: meeting-reports-api-service
      tls:
        certResolver: letsencrypt
      middlewares:
        - meeting-reports-stripprefix
        - meeting-reports-api-headers
        - meeting-reports-cors
        - meeting-reports-no-buffer
    
    meeting-reports-upload:
      rule: "Host(`meeting-reports.iahome.fr`) && PathPrefix(`/api/upload`)"
      service: meeting-reports-api-service
      tls:
        certResolver: letsencrypt
      middlewares:
        - meeting-reports-upload-nobuffer
        - meeting-reports-stripprefix
        - meeting-reports-api-headers
        - meeting-reports-cors

  services:
    meeting-reports-api-service:
      loadBalancer:
        servers:
          - url: "http://localhost:8000"
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "5s"

  middlewares:
    meeting-reports-no-buffer:
      buffering:
        maxRequestBodyBytes: 524288000  # 500 MB
    
    meeting-reports-upload-nobuffer:
      buffering:
        maxRequestBodyBytes: 524288000  # 500 MB
    
    meeting-reports-stripprefix:
      stripPrefix:
        prefixes:
          - "/api"
    
    meeting-reports-api-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-For: ""
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          Referrer-Policy: "strict-origin-when-cross-origin"
    
    meeting-reports-cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Content-Type
          - Authorization
          - X-Requested-With
        accessControlAllowOriginList:
          - "https://meeting-reports.iahome.fr"
          - "http://localhost:3001"
        accessControlMaxAge: 100
        addVaryHeader: true

