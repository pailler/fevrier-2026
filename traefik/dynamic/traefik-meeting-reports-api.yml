# Configuration Traefik pour l'API Meeting Reports Generator
# Placez ce fichier dans votre répertoire traefik/dynamic/

http:
  routers:
    # Route spécifique pour upload - DOIT être en premier pour avoir la priorité
    meeting-reports-upload:
      rule: "Host(`meeting-reports.iahome.fr`) && PathPrefix(`/api/upload`)"
      service: meeting-reports-api-service
      priority: 10  # Priorité élevée pour être évaluée en premier
      tls:
        certResolver: letsencrypt
      middlewares:
        - meeting-reports-upload-nobuffer
        - meeting-reports-stripprefix
        - meeting-reports-api-headers
        - meeting-reports-cors
    
    # Route générale pour /api - doit exclure /api/upload
    meeting-reports-api:
      rule: "Host(`meeting-reports.iahome.fr`) && PathPrefix(`/api`) && !PathPrefix(`/api/upload`)"
      service: meeting-reports-api-service
      priority: 1  # Priorité plus basse
      tls:
        certResolver: letsencrypt
      middlewares:
        - meeting-reports-stripprefix
        - meeting-reports-api-headers
        - meeting-reports-cors
        - meeting-reports-no-buffer

  services:
    meeting-reports-api-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:8000"  # Accès depuis le conteneur Docker
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "5s"

  middlewares:
    meeting-reports-no-buffer:
      buffering:
        maxRequestBodyBytes: 524288000  # 500 MB maximum
        memRequestBodyBytes: 524288000  # 500 MB en mémoire - désactive le streaming sur disque
        memResponseBodyBytes: 10485760  # 10 MB pour les réponses
    
    meeting-reports-upload-nobuffer:
      # Configuration pour streaming des gros fichiers
      # Désactiver complètement le buffering pour permettre le streaming pur
      # memRequestBodyBytes par défaut à 2MB, on l'augmente considérablement
      buffering:
        maxRequestBodyBytes: 524288000  # 500 MB maximum
        memRequestBodyBytes: 524288000  # 500 MB en mémoire - désactive le streaming sur disque
        memResponseBodyBytes: 10485760  # 10 MB pour les réponses
        retryExpression: "IsNetworkError() && Attempts() < 3"
    
    meeting-reports-stripprefix:
      stripPrefix:
        prefixes:
          - "/api"
    
    meeting-reports-api-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-For: ""
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          Referrer-Policy: "strict-origin-when-cross-origin"
    
    meeting-reports-cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Content-Type
          - Authorization
          - X-Requested-With
        accessControlAllowOriginList:
          - "https://meeting-reports.iahome.fr"
          - "http://localhost:3001"
        accessControlMaxAge: 100
        addVaryHeader: true

