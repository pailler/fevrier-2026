# Middleware Traefik pour la validation des tokens LibreSpeed
http:
  middlewares:
    # Middleware de validation de token LibreSpeed
    librespeed-token-validator:
      forwardAuth:
        address: "http://iahome-app:3000/api/librespeed-token-validator"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Email"
          - "X-Token-Valid"
        authRequestHeaders:
          - "Authorization"
          - "Cookie"
          - "X-Forwarded-For"
          - "X-Forwarded-Proto"
          - "X-Forwarded-Host"
          - "X-Real-IP"
          - "X-Original-URL"

    # Middleware de redirection vers LibreSpeed avec token valide
    librespeed-token-redirect:
      redirectRegex:
        regex: "^https://librespeed\\.iahome\\.fr(.*)$"
        replacement: "https://iahome.fr/api/redirect-librespeed$1"
        permanent: false

    # Middleware de blocage pour les tokens invalides
    librespeed-token-block:
      errors:
        status:
          - "401"
          - "403"
        service: librespeed-blocked-service
        query: "/api/librespeed-blocked"

  routers:
    # Route pour LibreSpeed avec token valide
    librespeed-token-access:
      rule: "Host(`librespeed.iahome.fr`) && Query(`token`, `.+`)"
      entryPoints: ["websecure"]
      service: librespeed-token-service
      middlewares: ["librespeed-token-validator", "security-headers@file", "compress@file"]
      tls: {}
      priority: 300

    # Route de redirection pour LibreSpeed sans token
    librespeed-no-token:
      rule: "Host(`librespeed.iahome.fr`)"
      entryPoints: ["websecure"]
      service: librespeed-redirect-service
      middlewares: ["librespeed-token-redirect", "security-headers@file", "compress@file"]
      tls: {}
      priority: 200

  services:
    # Service LibreSpeed avec token valide
    librespeed-token-service:
      loadBalancer:
        servers:
          - url: "http://librespeed:80"
        passHostHeader: true

    # Service de redirection vers l'API
    librespeed-redirect-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

    # Service de blocage
    librespeed-blocked-service:
      loadBalancer:
        servers:
          - url: "http://iahome-app:3000"
        passHostHeader: true

# Configuration mise Ã  jour le 20/01/2025 - Validation de tokens
