<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator - IAHome</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        /* IAHome Banner Styles - QR Code Page */
        .iahome-banner {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            padding: 60px 0;
            position: relative;
            overflow: hidden;
        }

        .banner-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        .banner-left {
            flex: 1;
            max-width: 600px;
        }

        .banner-right {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .banner-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .banner-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 30px;
            line-height: 1.6;
        }


        .banner-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .banner-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .banner-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .banner-button.primary {
            background: white;
            color: #3b82f6;
            font-weight: 600;
        }

        .banner-button.primary:hover {
            background: #f8fafc;
            transform: translateY(-2px);
        }

        .banner-nav-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .banner-nav-buttons .banner-button {
            font-size: 1rem;
            padding: 14px 28px;
            font-weight: 600;
        }

        /* Top banner info */
        .banner-top-info {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: white;
        }

        .user-email {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            opacity: 0.9;
        }

        /* Geometric shapes for banner decoration */
        .banner-shapes {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
        }

        .shape-1 {
            width: 80px;
            height: 80px;
            background: rgba(59, 130, 246, 0.3);
            top: 20%;
            right: 15%;
        }

        .shape-2 {
            width: 60px;
            height: 60px;
            background: rgba(139, 92, 246, 0.2);
            top: 60%;
            right: 25%;
        }

        .shape-3 {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            top: 40%;
            right: 35%;
        }

        .shape-4 {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.15);
            top: 80%;
            right: 45%;
        }

        /* Central QR icon */
        .qr-icon {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 3;
        }

        .qr-icon-inner {
            width: 60px;
            height: 60px;
            background: #3b82f6;
            border-radius: 8px;
            position: relative;
        }

        .qr-icon-inner::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 2px;
        }

        .qr-icon-inner::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 2px;
        }
        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .user-info {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        
        /* Workflow Progress Bar */
        .workflow-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .progress-step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin: 0 15px;
            position: relative;
            transition: all 0.3s ease;
            border: 3px solid #e9ecef;
        }
        
        .progress-step.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
            transform: scale(1.1);
        }
        
        .progress-step.completed {
            background: #28a745;
            color: white;
            border-color: #218838;
        }
        
        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 3px;
            background: #e9ecef;
            transition: background 0.3s ease;
        }
        
        .progress-step.completed:not(:last-child)::after {
            background: #28a745;
        }
        
        .progress-step.active:not(:last-child)::after {
            background: #007bff;
        }
        
        .step-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
        }
        
        /* Workflow Content */
        .workflow-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .workflow-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Navigation Buttons */
        .workflow-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .nav-button {
            background-color: #6c757d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-button:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .nav-button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .nav-button.primary {
            background-color: #007bff;
        }
        
        .nav-button.primary:hover {
            background-color: #0056b3;
        }
        
        .nav-button.success {
            background-color: #28a745;
        }
        
        .nav-button.success:hover {
            background-color: #218838;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .progress-step {
                width: 40px;
                height: 40px;
                font-size: 16px;
                margin: 0 10px;
            }
            .progress-step:not(:last-child)::after {
                right: -20px;
                width: 20px;
            }
        }
        
        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .option-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .option-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        }
        
        .option-card.selected {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        
        .option-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .option-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .option-description {
            font-size: 12px;
            color: #666;
        }
        
        /* Result Section */
        .result {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .qr-code {
            margin: 20px 0;
        }
        
        .qr-code img {
            max-width: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .action-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .action-btn:hover {
            background-color: #0056b3;
        }
        
        .action-btn.success {
            background-color: #28a745;
        }
        
        .action-btn.success:hover {
            background-color: #218838;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
                 @keyframes spin {
             0% { transform: rotate(0deg); }
             100% { transform: rotate(360deg); }
         }
         
         /* Management Section */
         .management-controls {
             display: flex;
             gap: 15px;
             justify-content: center;
             margin-bottom: 30px;
         }
         
         .qr-codes-list {
             max-height: 600px;
             overflow-y: auto;
         }
         
         .qr-code-item {
             background: white;
             border: 2px solid #e9ecef;
             border-radius: 8px;
             padding: 20px;
             margin-bottom: 15px;
             transition: all 0.3s ease;
         }
         
         .qr-code-item:hover {
             border-color: #007bff;
             box-shadow: 0 4px 12px rgba(0,123,255,0.15);
         }
         
         .qr-code-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 15px;
         }
         
         .qr-code-title {
             font-weight: bold;
             color: #333;
             font-size: 18px;
         }
         
         .qr-code-id {
             color: #666;
             font-size: 12px;
             font-family: monospace;
         }
         
         .qr-code-content {
             display: grid;
             grid-template-columns: 1fr 200px;
             gap: 20px;
             align-items: center;
         }
         
         .qr-code-info {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }
         
         .qr-code-url {
             color: #007bff;
             text-decoration: none;
             word-break: break-all;
         }
         
         .qr-code-url:hover {
             text-decoration: underline;
         }
         
         .qr-code-image {
             text-align: center;
         }
         
         .qr-code-image img {
             max-width: 150px;
             border-radius: 8px;
             box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         }
         
         .qr-code-actions {
             display: flex;
             gap: 10px;
             margin-top: 15px;
         }
         
         .qr-action-btn {
             background-color: #6c757d;
             color: white;
             padding: 8px 16px;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             font-size: 12px;
             transition: background-color 0.3s;
         }
         
         .qr-action-btn:hover {
             background-color: #5a6268;
         }
         
         .qr-action-btn.edit {
             background-color: #007bff;
         }
         
         .qr-action-btn.edit:hover {
             background-color: #0056b3;
         }
         
         .qr-action-btn.delete {
             background-color: #dc3545;
         }
         
         .qr-action-btn.delete:hover {
             background-color: #c82333;
         }
         
         .qr-action-btn.download {
             background-color: #28a745;
         }
         
         .qr-action-btn.download:hover {
             background-color: #218838;
         }
         
         .edit-form {
             background: #f8f9fa;
             border: 1px solid #dee2e6;
             border-radius: 6px;
             padding: 15px;
             margin-top: 15px;
         }
         
         .edit-form input {
             margin-bottom: 10px;
         }
         
         .edit-form-buttons {
             display: flex;
             gap: 10px;
             margin-top: 10px;
         }
         
         .no-qr-codes {
             text-align: center;
             padding: 40px;
             color: #666;
         }
         
                   @media (max-width: 768px) {
              .qr-code-content {
                  grid-template-columns: 1fr;
              }
              
              .qr-code-actions {
                  flex-wrap: wrap;
              }
          }
          
    </style>
</head>
<body>
    <!-- IAHome Banner - QR Code Page -->
    <div class="iahome-banner">
        <div class="banner-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
            <div class="shape shape-4"></div>
        </div>
        <div class="banner-container">
            <div class="banner-left">
                <h1 class="banner-title">G√©n√©rez des QR codes dynamiques</h1>
                <p class="banner-subtitle">
                    Cr√©ez des QR codes dynamiques avec suivi en temps r√©el, personnalisation avanc√©e et analytics d√©taill√©s pour optimiser vos campagnes marketing.
                </p>
                <div class="banner-nav-buttons">
                    <button class="banner-button primary" onclick="resetWorkflow()">
                        üéØ Nouveau QR Code
                    </button>
                </div>
            </div>
            <div class="banner-right">
                <div class="qr-icon">
                    <div class="qr-icon-inner"></div>
                </div>
            </div>
        </div>
        
        <!-- User connection info in top banner -->
        <div class="banner-top-info">
            <div class="connection-status" id="connection-status">
                <span class="status-dot"></span>
                <span class="status-text">Connect√© via IAHome</span>
                <span class="user-email" id="user-email">Chargement...</span>
            </div>
        </div>
    </div>

    <div class="container">
        
        <h1>üéØ QR Code Generator</h1>
        
                 <!-- Workflow Progress -->
         <div class="workflow-progress">
             <div class="progress-step active" id="step1-indicator">
                 1
                 <div class="step-label">Style</div>
             </div>
             <div class="progress-step" id="step2-indicator">
                 2
                 <div class="step-label">Couleurs</div>
             </div>
            <div class="progress-step" id="step3-indicator">
                3
                <div class="step-label">Cible</div>
            </div>
            <div class="progress-step" id="step5-indicator">
                4
                <div class="step-label">Qualit√©</div>
            </div>
             <div class="progress-step" id="step6-indicator">
                 6
                 <div class="step-label">Logo</div>
             </div>
             <div class="progress-step" id="step7-indicator">
                 7
                 <div class="step-label">Cr√©ation</div>
             </div>
         </div>
        
        <!-- Step 1: Style Selection -->
        <div id="step1" class="workflow-content active">
            <h2>√âtape 1 : Choisir le style du QR Code</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                S√©lectionnez le style visuel de votre QR code
            </p>
            
            <div class="options-grid">
                <div class="option-card" data-style="classic" onclick="selectStyle('classic')">
                    <div class="option-icon">‚¨ú</div>
                    <div class="option-title">Carr√© Classique</div>
                    <div class="option-description">Style traditionnel avec modules carr√©s</div>
                </div>
                
                <div class="option-card" data-style="rounded" onclick="selectStyle('rounded')">
                    <div class="option-icon">üî≤</div>
                    <div class="option-title">Arrondi</div>
                    <div class="option-description">Modules avec coins arrondis</div>
                </div>
                
                <div class="option-card" data-style="dots" onclick="selectStyle('dots')">
                    <div class="option-icon">üîò</div>
                    <div class="option-title">Points</div>
                    <div class="option-description">Modules circulaires</div>
                </div>
                
                <div class="option-card" data-style="artistic" onclick="selectStyle('artistic')">
                    <div class="option-icon">üé®</div>
                    <div class="option-title">Artistique</div>
                    <div class="option-description">Style cr√©atif et moderne</div>
                </div>
            </div>
            
            <div class="workflow-navigation">
                <div></div>
                <button class="nav-button primary" onclick="nextStep(1)">
                    Suivant ‚Üí
                </button>
            </div>
                 </div>
         
         <!-- Step 2: Color Selection -->
         <div id="step2" class="workflow-content">
             <h2>√âtape 2 : Personnaliser les couleurs</h2>
             <p style="text-align: center; color: #666; margin-bottom: 30px;">
                 Choisissez les couleurs de votre QR code
             </p>
             
             <div class="form-row">
                 <div class="form-group">
                     <label for="foregroundColor">Couleur principale :</label>
                     <input type="color" id="foregroundColor" value="#000000" style="height: 50px; padding: 5px;">
                     <small style="color: #666;">Couleur des modules du QR code</small>
                 </div>
                 <div class="form-group">
                     <label for="backgroundColor">Couleur d'arri√®re-plan :</label>
                     <input type="color" id="backgroundColor" value="#FFFFFF" style="height: 50px; padding: 5px;">
                     <small style="color: #666;">Couleur de fond du QR code</small>
                 </div>
             </div>
             
             <div class="form-group">
                 <label for="colorScheme">Sch√©ma de couleurs pr√©d√©fini :</label>
                 <select id="colorScheme" onchange="applyColorScheme()">
                     <option value="custom">Personnalis√©</option>
                     <option value="classic">Classique (Noir/Blanc)</option>
                     <option value="blue">Bleu moderne</option>
                     <option value="green">Vert nature</option>
                     <option value="purple">Violet √©l√©gant</option>
                     <option value="orange">Orange dynamique</option>
                     <option value="red">Rouge passion</option>
                     <option value="dark">Mode sombre</option>
                 </select>
             </div>
             
             <div class="workflow-navigation">
                 <button class="nav-button" onclick="prevStep(2)">
                     ‚Üê Pr√©c√©dent
                 </button>
                 <button class="nav-button primary" onclick="nextStep(2)">
                     Suivant ‚Üí
                 </button>
             </div>
         </div>
         
                  <!-- Step 3: Target Selection -->
         <div id="step3" class="workflow-content">
             <h2>√âtape 3 : Choisir la cible du QR Code</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Quel type de contenu voulez-vous encoder ?
            </p>
            
            <div class="options-grid">
                <div class="option-card" data-target="web" onclick="selectTarget('web')">
                    <div class="option-icon">üåê</div>
                    <div class="option-title">Site Web</div>
                    <div class="option-description">URL, page web, application</div>
                </div>
                
                <div class="option-card" data-target="social" onclick="selectTarget('social')">
                    <div class="option-icon">üì±</div>
                    <div class="option-title">R√©seaux Sociaux</div>
                    <div class="option-description">Instagram, LinkedIn, TikTok, etc.</div>
                </div>
                
                <div class="option-card" data-target="contact" onclick="selectTarget('contact')">
                    <div class="option-icon">üë§</div>
                    <div class="option-title">Contact</div>
                    <div class="option-description">Email, t√©l√©phone, carte de visite</div>
                </div>
                
                <div class="option-card" data-target="media" onclick="selectTarget('media')">
                    <div class="option-icon">üé¨</div>
                    <div class="option-title">Multim√©dia</div>
                    <div class="option-description">Vid√©o, audio, images, PDF</div>
                </div>
                
                <div class="option-card" data-target="interactive" onclick="selectTarget('interactive')">
                    <div class="option-icon">‚ö°</div>
                    <div class="option-title">Actions Interactives</div>
                    <div class="option-description">Wi-Fi, g√©olocalisation, paiement</div>
                </div>
            </div>
            
                         <div class="workflow-navigation">
                 <button class="nav-button" onclick="prevStep(3)">
                     ‚Üê Pr√©c√©dent
                 </button>
                 <button class="nav-button primary" onclick="nextStep(3)">
                     Suivant ‚Üí
                 </button>
             </div>
         </div>
         
                         <div class="workflow-navigation">
                 <button class="nav-button" onclick="prevStep(4)">
                     ‚Üê Pr√©c√©dent
                 </button>
                 <button class="nav-button primary" onclick="nextStep(4)">
                     Suivant ‚Üí
                 </button>
             </div>
         </div>
         
         <!-- Step 5: Quality Selection -->
         <div id="step5" class="workflow-content">
             <h2>√âtape 5 : Choisir la qualit√© d'export</h2>
             <p style="text-align: center; color: #666; margin-bottom: 30px;">
                 S√©lectionnez la qualit√© et la taille de votre QR code
             </p>
             
             <div class="form-row">
                 <div class="form-group">
                     <label for="exportSize">Taille d'export :</label>
                     <select id="exportSize">
                         <option value="300">Petite (300px) - Web</option>
                         <option value="500" selected>Moyenne (500px) - Impression</option>
                         <option value="800">Grande (800px) - Haute qualit√©</option>
                         <option value="1200">Tr√®s grande (1200px) - Professionnel</option>
                         <option value="2000">Maximum (2000px) - Ultra qualit√©</option>
                     </select>
                     <small style="color: #666;">Taille en pixels du QR code g√©n√©r√©</small>
                 </div>
                 <div class="form-group">
                     <label for="errorCorrection">Niveau de correction d'erreur :</label>
                     <select id="errorCorrection">
                         <option value="L">Faible (L) - 7%</option>
                         <option value="M" selected>Moyen (M) - 15%</option>
                         <option value="Q">√âlev√© (Q) - 25%</option>
                         <option value="H">Maximum (H) - 30%</option>
                     </select>
                     <small style="color: #666;">Plus √©lev√© = plus robuste mais plus grand</small>
                 </div>
             </div>
             
             <div class="form-group">
                 <label for="exportFormat">Format d'export :</label>
                 <select id="exportFormat">
                     <option value="PNG" selected>PNG - Qualit√© optimale</option>
                     <option value="SVG">SVG - Vectoriel (redimensionnable)</option>
                     <option value="PDF">PDF - Document imprimable</option>
                 </select>
                 <small style="color: #666;">Format de fichier pour le t√©l√©chargement</small>
             </div>
             
             <div class="workflow-navigation">
                 <button class="nav-button" onclick="prevStep(5)">
                     ‚Üê Pr√©c√©dent
                 </button>
                 <button class="nav-button primary" onclick="nextStep(5)">
                     Suivant ‚Üí
                 </button>
             </div>
         </div>
         
                           <!-- Step 6: Logo Selection -->
         <div id="step6" class="workflow-content">
             <h2>√âtape 6 : Ajouter un logo (optionnel)</h2>
             <p style="text-align: center; color: #666; margin-bottom: 30px;">
                 Personnalisez votre QR code avec votre logo
             </p>
             
             <div class="form-group">
                 <label for="logoFile">S√©lectionner un logo :</label>
                 <input type="file" id="logoFile" accept="image/*" onchange="previewLogo()">
                 <small style="color: #666;">Formats accept√©s : PNG, JPG, JPEG, SVG (max 2MB)</small>
             </div>
             
             <div id="logoPreview" style="display: none; margin: 20px 0;">
                 <h4>Aper√ßu du logo :</h4>
                 <img id="previewImage" style="max-width: 200px; border: 2px solid #e9ecef; border-radius: 8px;">
                 <button type="button" class="nav-button" onclick="removeLogo()" style="margin-left: 10px;">
                     ‚ùå Supprimer
                 </button>
             </div>
             
             <div class="form-row">
                 <div class="form-group">
                     <label for="logoSize">Taille du logo :</label>
                     <select id="logoSize">
                         <option value="10">Petit (10%)</option>
                         <option value="15" selected>Moyen (15%)</option>
                         <option value="20">Grand (20%)</option>
                         <option value="25">Tr√®s grand (25%)</option>
                     </select>
                     <small style="color: #666;">Taille relative au QR code</small>
                 </div>
                 <div class="form-group">
                     <label for="logoPosition">Position du logo :</label>
                     <select id="logoPosition">
                         <option value="center" selected>Centre</option>
                         <option value="top-left">Haut gauche</option>
                         <option value="top-right">Haut droite</option>
                         <option value="bottom-left">Bas gauche</option>
                         <option value="bottom-right">Bas droite</option>
                     </select>
                     <small style="color: #666;">Position du logo sur le QR code</small>
                 </div>
             </div>
             
             <div class="workflow-navigation">
                 <button class="nav-button" onclick="prevStep(6)">
                     ‚Üê Pr√©c√©dent
                 </button>
                 <button class="nav-button primary" onclick="nextStep(6)">
                     Suivant ‚Üí
                 </button>
             </div>
         </div>
         
         <!-- Step 7: Content Configuration -->
         <div id="step7" class="workflow-content">
             <h2>√âtape 7 : Configurer le contenu</h2>
             <p style="text-align: center; color: #666; margin-bottom: 30px;">
                 Configurez les d√©tails selon vos s√©lections
             </p>
             
             <div id="content-config">
                 <!-- Content will be dynamically loaded based on previous selections -->
             </div>
             
             <div class="workflow-navigation">
                 <button class="nav-button" onclick="prevStep(7)">
                     ‚Üê Pr√©c√©dent
                 </button>
                 <button class="nav-button success" onclick="generateQRCode()">
                     üéØ Cr√©er le QR Code
                 </button>
             </div>
         </div>
        
                 <!-- Result Section -->
         <div id="result" class="workflow-content">
             <h2>QR Code G√©n√©r√© !</h2>
             <div id="qrResult" class="result">
                 <!-- QR code will be displayed here -->
             </div>
             
             <div class="workflow-navigation">
                 <button class="nav-button" onclick="resetWorkflow()">
                     üè† Nouveau QR Code
                 </button>
                 <div class="action-buttons">
                     <button class="action-btn" onclick="downloadQR()">üì• T√©l√©charger</button>
                     <button class="action-btn success" onclick="shareQR()">üì§ Partager</button>
                 </div>
             </div>
         </div>
         
         <!-- Management Section -->
         <div id="management" class="workflow-content">
             <h2>Mes QR Codes</h2>
             <p style="text-align: center; color: #666; margin-bottom: 30px;">
                 Consultez, modifiez et supprimez vos QR codes dynamiques
             </p>
             
                           <div class="management-controls">
                  <button class="nav-button primary" onclick="loadDynamicQRCodes()">
                      üîÑ Actualiser
                  </button>
                  <button class="nav-button" onclick="showStep('statistics')">
                      üìä Statistiques
                  </button>
                  <button class="nav-button" onclick="resetWorkflow()">
                      üè† Nouveau QR Code
                  </button>
              </div>
             
             <div id="qrCodesList" class="qr-codes-list">
                 <!-- QR codes will be loaded here -->
                 <div class="loading">
                     <div class="spinner"></div>
                     <p>Chargement des QR codes...</p>
                 </div>
             </div>
         </div>
         
    </div>

    <script>
                 // Workflow state with persistence
         let workflowState = {
             style: null,
             colors: {
                 foreground: '#000000',
                 background: '#FFFFFF',
                 scheme: 'custom'
             },
             target: null,
             type: null,
             quality: {
                 size: 500,
                 errorCorrection: 'M',
                 format: 'PNG'
             },
             logo: {
                 file: null,
                 size: 15,
                 position: 'center'
             },
             content: {}
         };
        
        // Get auth token from URL
        function getAuthToken() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('auth_token');
        }
        
        // User authentication and session management
        let currentUser = null;
        let authToken = null;
        
        // Initialize authentication
        function initializeAuth() {
            authToken = getAuthToken();
            
            if (authToken) {
                // User is authenticated, validate token and get user info
                validateTokenAndGetUserInfo();
            } else {
                // User is not authenticated, show login button
                showLoginButton();
            }
        }
        
        // Validate token and get user information
        async function validateTokenAndGetUserInfo() {
            try {
                const response = await fetch('/api/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: authToken })
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    currentUser = userInfo;
                    showUserInfo(userInfo);
                } else {
                    console.error('Token validation failed');
                    showLoginButton();
                }
            } catch (error) {
                console.error('Error validating token:', error);
                showLoginButton();
            }
        }
        
        // Show user information
        function showUserInfo(userInfo) {
            const connectionStatus = document.getElementById('connection-status');
            const userEmail = document.getElementById('user-email');
            
            if (connectionStatus && userEmail) {
                userEmail.textContent = userInfo.email || userInfo.userEmail || 'Utilisateur IAHome';
                connectionStatus.style.display = 'flex';
            }
            
            // Load user's QR codes
            loadUserQRCodes();
        }
        
        // Show login button
        function showLoginButton() {
            const connectionStatus = document.getElementById('connection-status');
            
            if (connectionStatus) {
                connectionStatus.style.display = 'none';
            }
        }
        
        
        // Load user's QR codes
        async function loadUserQRCodes() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/dynamic/qr', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateUserStats(data.qr_codes);
                        displayUserQRCodes(data.qr_codes);
                    }
                }
            } catch (error) {
                console.error('Error loading user QR codes:', error);
            }
        }
        
        // Update user statistics
        function updateUserStats(qrCodes) {
            const totalQRCodes = Object.keys(qrCodes).length;
            const totalScans = Object.values(qrCodes).reduce((sum, qr) => sum + (qr.scans || 0), 0);
            const avgScans = totalQRCodes > 0 ? Math.round(totalScans / totalQRCodes) : 0;
            
        }
        
        // Display user's QR codes in management section
        function displayUserQRCodes(qrCodes) {
            const qrCodesList = document.getElementById('qr-codes-list');
            if (!qrCodesList) return;
            
            if (Object.keys(qrCodes).length === 0) {
                qrCodesList.innerHTML = '<p class="no-qr-codes">Aucun QR code cr√©√© pour le moment.</p>';
                return;
            }
            
            let html = '';
            Object.values(qrCodes).forEach(qr => {
                html += `
                    <div class="qr-code-item">
                        <div class="qr-code-info">
                            <h4>${qr.name || 'QR Code sans nom'}</h4>
                            <p>URL: ${qr.url}</p>
                            <p>Cr√©√© le: ${new Date(qr.created_at).toLocaleDateString()}</p>
                            <p>Scans: ${qr.scans || 0}</p>
                        </div>
                        <div class="qr-code-actions">
                            <button onclick="editQRCode('${qr.qr_id}')" class="btn btn-secondary">Modifier</button>
                            <button onclick="downloadQRCode('${qr.qr_id}')" class="btn btn-primary">T√©l√©charger</button>
                            <button onclick="deleteQRCode('${qr.qr_id}')" class="btn btn-danger">Supprimer</button>
                        </div>
                    </div>
                `;
            });
            
            qrCodesList.innerHTML = html;
        }
        
                 // Step navigation with state persistence
         function showStep(stepNumber) {
             // Hide all steps
             document.querySelectorAll('.workflow-content').forEach(content => {
                 content.classList.remove('active');
             });
             
             // Show selected step
             let stepElement;
             if (stepNumber === 'result') {
                 stepElement = document.getElementById('result');
             } else if (stepNumber === 'management') {
                 stepElement = document.getElementById('management');
             } else if (stepNumber === 'statistics') {
                 stepElement = document.getElementById('statistics');
             } else {
                 stepElement = document.getElementById(`step${stepNumber}`);
             }
             
             if (stepElement) {
                 stepElement.classList.add('active');
             } else {
                 console.error(`Step ${stepNumber} not found in DOM`);
                 return;
             }
             
             // Update progress indicators only for numeric steps
             if (typeof stepNumber === 'number') {
                 updateProgressIndicators(stepNumber);
                 // Restore selections for the current step
                 restoreStepSelections(stepNumber);
             }
             
             // Auto-load QR codes when management section is shown
             if (stepNumber === 'management') {
                 setTimeout(loadDynamicQRCodes, 100);
             }
             
         }
        
        function updateProgressIndicators(currentStep) {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                }
            });
        }
        
                 function restoreStepSelections(stepNumber) {
             switch (stepNumber) {
                 case 1:
                     if (workflowState.style) {
                         selectStyle(workflowState.style);
                     }
                     break;
                 case 2:
                     if (workflowState.colors) {
                         restoreColorSelections();
                     }
                     break;
                 case 3:
                     if (workflowState.target) {
                         selectTarget(workflowState.target);
                     }
                     break;
                 case 4:
                     if (workflowState.quality) {
                         restoreQualitySelections();
                     }
                     break;
                 case 6:
                     if (workflowState.logo) {
                         restoreLogoSelections();
                     }
                     break;
                 case 7:
                     if (workflowState.target) {
                         loadContentConfiguration();
                         // Restore form values
                         setTimeout(() => {
                             restoreFormValues();
                         }, 100);
                     }
                     break;
             }
         }
        
        function restoreFormValues() {
            // Restore form values based on workflowState.content
            Object.keys(workflowState.content).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = workflowState.content[key];
                    
                    // Trigger change events for dynamic fields
                    if (element.tagName === 'SELECT') {
                        element.dispatchEvent(new Event('change'));
                    }
                }
            });
        }
        
                 function nextStep(currentStep) {
             // Validate current step
             if (currentStep === 1 && !workflowState.style) {
                 alert('Veuillez s√©lectionner un style');
                 return;
             }
             if (currentStep === 2) {
                 saveColorSelections();
             }
             if (currentStep === 3 && !workflowState.target) {
                 alert('Veuillez s√©lectionner une cible');
                 return;
             }
             if (currentStep === 3) {
                 // Passer directement √† l'√©tape 5 (maintenant 4) en sautant l'√©tape 4 supprim√©e
                 showStep(5);
                 return;
             }
             if (currentStep === 5) {
                 saveQualitySelections();
             }
             if (currentStep === 6) {
                 saveLogoSelections();
             }
             
             // Save form data if moving from step 7
             if (currentStep === 7) {
                 saveFormData();
             }
             
             if (currentStep === 4) {
                 // Load content configuration for step 7
                 loadContentConfiguration();
             }
             
             showStep(currentStep + 1);
         }
        
                 function prevStep(currentStep) {
             // Save form data if moving from step 7
             if (currentStep === 7) {
                 saveFormData();
             }
             
             // Si on est √† l'√©tape 5 (maintenant 4), retourner √† l'√©tape 3
             if (currentStep === 5) {
                 showStep(3);
                 return;
             }
             
             showStep(currentStep - 1);
         }
        
        function saveFormData() {
            // Save all form values to workflowState.content
            const formElements = document.querySelectorAll('#content-config input, #content-config select, #content-config textarea');
            formElements.forEach(element => {
                if (element.id) {
                    workflowState.content[element.id] = element.value;
                }
            });
        }
        
        // Selection functions
        function selectStyle(style) {
            workflowState.style = style;
            
            // Update UI
            document.querySelectorAll('.option-card[data-style]').forEach(card => {
                card.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-style="${style}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        }
        
        function selectTarget(target) {
            workflowState.target = target;
            
            // Update UI
            document.querySelectorAll('.option-card[data-target]').forEach(card => {
                card.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-target="${target}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        }
        
         
         // Color management functions
         function saveColorSelections() {
             const foregroundColor = document.getElementById('foregroundColor')?.value || '#000000';
             const backgroundColor = document.getElementById('backgroundColor')?.value || '#FFFFFF';
             const colorScheme = document.getElementById('colorScheme')?.value || 'custom';
             
             workflowState.colors = {
                 foreground: foregroundColor,
                 background: backgroundColor,
                 scheme: colorScheme
             };
         }
         
         function restoreColorSelections() {
             if (workflowState.colors) {
                 const foregroundColorInput = document.getElementById('foregroundColor');
                 const backgroundColorInput = document.getElementById('backgroundColor');
                 const colorSchemeSelect = document.getElementById('colorScheme');
                 
                 if (foregroundColorInput) foregroundColorInput.value = workflowState.colors.foreground;
                 if (backgroundColorInput) backgroundColorInput.value = workflowState.colors.background;
                 if (colorSchemeSelect) colorSchemeSelect.value = workflowState.colors.scheme;
             }
         }
         
         function applyColorScheme() {
             const scheme = document.getElementById('colorScheme')?.value;
             const foregroundInput = document.getElementById('foregroundColor');
             const backgroundInput = document.getElementById('backgroundColor');
             
             if (!foregroundInput || !backgroundInput) return;
             
             const schemes = {
                 'classic': { foreground: '#000000', background: '#FFFFFF' },
                 'blue': { foreground: '#1E3A8A', background: '#EFF6FF' },
                 'green': { foreground: '#166534', background: '#F0FDF4' },
                 'purple': { foreground: '#7C3AED', background: '#FAF5FF' },
                 'orange': { foreground: '#EA580C', background: '#FFF7ED' },
                 'red': { foreground: '#DC2626', background: '#FEF2F2' },
                 'dark': { foreground: '#FFFFFF', background: '#1F2937' }
             };
             
             if (schemes[scheme]) {
                 foregroundInput.value = schemes[scheme].foreground;
                 backgroundInput.value = schemes[scheme].background;
             }
         }
         
         // Quality management functions
         function saveQualitySelections() {
             const exportSize = document.getElementById('exportSize')?.value || '500';
             const errorCorrection = document.getElementById('errorCorrection')?.value || 'M';
             const exportFormat = document.getElementById('exportFormat')?.value || 'PNG';
             
             workflowState.quality = {
                 size: parseInt(exportSize),
                 errorCorrection: errorCorrection,
                 format: exportFormat
             };
         }
         
         function restoreQualitySelections() {
             if (workflowState.quality) {
                 const exportSizeSelect = document.getElementById('exportSize');
                 const errorCorrectionSelect = document.getElementById('errorCorrection');
                 const exportFormatSelect = document.getElementById('exportFormat');
                 
                 if (exportSizeSelect) exportSizeSelect.value = workflowState.quality.size.toString();
                 if (errorCorrectionSelect) errorCorrectionSelect.value = workflowState.quality.errorCorrection;
                 if (exportFormatSelect) exportFormatSelect.value = workflowState.quality.format;
             }
         }
         
         // Logo management functions
         function saveLogoSelections() {
             const logoSize = document.getElementById('logoSize')?.value || '15';
             const logoPosition = document.getElementById('logoPosition')?.value || 'center';
             
             workflowState.logo = {
                 file: workflowState.logo?.file || null,
                 size: parseInt(logoSize),
                 position: logoPosition
             };
         }
         
         function restoreLogoSelections() {
             if (workflowState.logo) {
                 const logoSizeSelect = document.getElementById('logoSize');
                 const logoPositionSelect = document.getElementById('logoPosition');
                 
                 if (logoSizeSelect) logoSizeSelect.value = workflowState.logo.size.toString();
                 if (logoPositionSelect) logoPositionSelect.value = workflowState.logo.position;
                 
                 // Restore logo preview if exists
                 if (workflowState.logo.file) {
                     const previewDiv = document.getElementById('logoPreview');
                     const previewImage = document.getElementById('previewImage');
                     if (previewDiv && previewImage) {
                         previewImage.src = workflowState.logo.file;
                         previewDiv.style.display = 'block';
                     }
                 }
             }
         }
         
         function previewLogo() {
             const fileInput = document.getElementById('logoFile');
             const previewDiv = document.getElementById('logoPreview');
             const previewImage = document.getElementById('previewImage');
             
             if (fileInput.files && fileInput.files[0]) {
                 const file = fileInput.files[0];
                 
                 // Validate file size (2MB max)
                 if (file.size > 2 * 1024 * 1024) {
                     alert('Le fichier est trop volumineux. Taille maximum : 2MB');
                     fileInput.value = '';
                     return;
                 }
                 
                 // Validate file type
                 const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/svg+xml'];
                 if (!validTypes.includes(file.type)) {
                     alert('Format de fichier non support√©. Utilisez PNG, JPG, JPEG ou SVG');
                     fileInput.value = '';
                     return;
                 }
                 
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     previewImage.src = e.target.result;
                     previewDiv.style.display = 'block';
                     
                     // Save logo data to workflow state
                     workflowState.logo = {
                         ...workflowState.logo,
                         file: e.target.result
                     };
                 };
                 reader.readAsDataURL(file);
             }
         }
         
         function removeLogo() {
             const fileInput = document.getElementById('logoFile');
             const previewDiv = document.getElementById('logoPreview');
             
             fileInput.value = '';
             previewDiv.style.display = 'none';
             
             // Clear logo from workflow state
             workflowState.logo = {
                 file: null,
                 size: workflowState.logo?.size || 15,
                 position: workflowState.logo?.position || 'center'
             };
         }
        
        // Load content configuration based on selections
        function loadContentConfiguration() {
            const configDiv = document.getElementById('content-config');
            let html = '';
            
            switch (workflowState.target) {
                case 'web':
                    html = `
                        <div class="form-group">
                            <label for="webUrl">URL du site web :</label>
                            <input type="url" id="webUrl" placeholder="https://example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="webTitle">Titre (optionnel) :</label>
                            <input type="text" id="webTitle" placeholder="Titre de la page">
                        </div>
                    `;
                    break;
                    
                case 'social':
                    html = `
                        <div class="form-group">
                            <label for="socialPlatform">Plateforme :</label>
                            <select id="socialPlatform" required>
                                <option value="">S√©lectionner une plateforme</option>
                                <option value="instagram">Instagram</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="tiktok">TikTok</option>
                                <option value="facebook">Facebook</option>
                                <option value="twitter">Twitter/X</option>
                                <option value="youtube">YouTube</option>
                                <option value="snapchat">Snapchat</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="telegram">Telegram</option>
                                <option value="discord">Discord</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="socialUsername">Nom d'utilisateur :</label>
                            <input type="text" id="socialUsername" placeholder="@username ou nom d'utilisateur" required>
                        </div>
                    `;
                    break;
                    
                case 'contact':
                    html = `
                        <div class="form-group">
                            <label for="contactType">Type de contact :</label>
                            <select id="contactType" required>
                                <option value="">S√©lectionner un type</option>
                                <option value="email">Email</option>
                                <option value="phone">T√©l√©phone</option>
                                <option value="sms">SMS</option>
                                <option value="vcard">Carte de visite (vCard)</option>
                            </select>
                        </div>
                        <div id="contactDetails" style="display: none;">
                            <!-- Dynamic contact fields will be loaded here -->
                        </div>
                    `;
                    break;
                    
                case 'media':
                    html = `
                        <div class="form-group">
                            <label for="mediaType">Type de m√©dia :</label>
                            <select id="mediaType" required>
                                <option value="">S√©lectionner un type</option>
                                <option value="video">Vid√©o (YouTube, Vimeo, MP4)</option>
                                <option value="audio">Audio (MP3, Spotify, Podcast)</option>
                                <option value="image">Image (JPG, PNG, PDF)</option>
                                <option value="presentation">Pr√©sentation (Google Slides, PDF)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mediaUrl">URL du m√©dia :</label>
                            <input type="url" id="mediaUrl" placeholder="https://..." required>
                        </div>
                    `;
                    break;
                    
                case 'interactive':
                    html = `
                        <div class="form-group">
                            <label for="interactiveType">Type d'action :</label>
                            <select id="interactiveType" required>
                                <option value="">S√©lectionner une action</option>
                                <option value="wifi">Connexion Wi-Fi</option>
                                <option value="geo">G√©olocalisation</option>
                                <option value="calendar">√âv√©nement calendrier</option>
                                <option value="payment">Paiement (PayPal, Stripe, Crypto)</option>
                            </select>
                        </div>
                        <div id="interactiveDetails" style="display: none;">
                            <!-- Dynamic interactive fields will be loaded here -->
                        </div>
                    `;
                    break;
            }
            
            configDiv.innerHTML = html;
            
            // Add event listeners for dynamic fields
            if (workflowState.target === 'contact') {
                const contactTypeSelect = document.getElementById('contactType');
                if (contactTypeSelect) {
                    contactTypeSelect.addEventListener('change', loadContactFields);
                }
            }
            if (workflowState.target === 'interactive') {
                const interactiveTypeSelect = document.getElementById('interactiveType');
                if (interactiveTypeSelect) {
                    interactiveTypeSelect.addEventListener('change', loadInteractiveFields);
                }
            }
            
            // Restore form values after loading
            setTimeout(() => {
                restoreFormValues();
            }, 100);
        }
        
        function loadContactFields() {
            const contactType = document.getElementById('contactType').value;
            const detailsDiv = document.getElementById('contactDetails');
            
            if (!contactType) {
                detailsDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            switch (contactType) {
                case 'email':
                    html = `
                        <div class="form-group">
                            <label for="contactEmail">Adresse email :</label>
                            <input type="email" id="contactEmail" placeholder="contact@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="contactSubject">Sujet (optionnel) :</label>
                            <input type="text" id="contactSubject" placeholder="Sujet de l'email">
                        </div>
                    `;
                    break;
                case 'phone':
                    html = `
                        <div class="form-group">
                            <label for="contactPhone">Num√©ro de t√©l√©phone :</label>
                            <input type="tel" id="contactPhone" placeholder="+33123456789" required>
                        </div>
                    `;
                    break;
                case 'sms':
                    html = `
                        <div class="form-group">
                            <label for="contactSmsPhone">Num√©ro de t√©l√©phone :</label>
                            <input type="tel" id="contactSmsPhone" placeholder="+33123456789" required>
                        </div>
                        <div class="form-group">
                            <label for="contactSmsMessage">Message (optionnel) :</label>
                            <textarea id="contactSmsMessage" placeholder="Bonjour, je vous contacte..."></textarea>
                        </div>
                    `;
                    break;
                case 'vcard':
                    html = `
                        <div class="form-group">
                            <label for="vcardName">Nom complet :</label>
                            <input type="text" id="vcardName" placeholder="Pr√©nom Nom" required>
                        </div>
                        <div class="form-group">
                            <label for="vcardPhone">T√©l√©phone :</label>
                            <input type="tel" id="vcardPhone" placeholder="+33123456789" required>
                        </div>
                        <div class="form-group">
                            <label for="vcardEmail">Email :</label>
                            <input type="email" id="vcardEmail" placeholder="contact@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="vcardCompany">Entreprise (optionnel) :</label>
                            <input type="text" id="vcardCompany" placeholder="Nom de l'entreprise">
                        </div>
                    `;
                    break;
            }
            
            detailsDiv.innerHTML = html;
            detailsDiv.style.display = 'block';
            
            // Restore form values for contact details
            setTimeout(() => {
                restoreFormValues();
            }, 100);
        }
        
        function loadInteractiveFields() {
            const interactiveType = document.getElementById('interactiveType').value;
            const detailsDiv = document.getElementById('interactiveDetails');
            
            if (!interactiveType) {
                detailsDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            switch (interactiveType) {
                case 'wifi':
                    html = `
                        <div class="form-group">
                            <label for="wifiSSID">Nom du r√©seau (SSID) :</label>
                            <input type="text" id="wifiSSID" placeholder="MonWiFi" required>
                        </div>
                        <div class="form-group">
                            <label for="wifiPassword">Mot de passe :</label>
                            <input type="password" id="wifiPassword" placeholder="Mot de passe">
                        </div>
                        <div class="form-group">
                            <label for="wifiEncryption">Type de chiffrement :</label>
                            <select id="wifiEncryption">
                                <option value="WPA">WPA/WPA2/WPA3</option>
                                <option value="WEP">WEP</option>
                                <option value="nopass">Aucun</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'geo':
                    html = `
                        <div class="form-group">
                            <label for="geoLatitude">Latitude :</label>
                            <input type="number" id="geoLatitude" step="any" placeholder="48.8566" required>
                        </div>
                        <div class="form-group">
                            <label for="geoLongitude">Longitude :</label>
                            <input type="number" id="geoLongitude" step="any" placeholder="2.3522" required>
                        </div>
                        <div class="form-group">
                            <label for="geoLabel">Label (optionnel) :</label>
                            <input type="text" id="geoLabel" placeholder="Tour Eiffel">
                        </div>
                    `;
                    break;
                case 'calendar':
                    html = `
                        <div class="form-group">
                            <label for="calendarTitle">Titre de l'√©v√©nement :</label>
                            <input type="text" id="calendarTitle" placeholder="R√©union importante" required>
                        </div>
                        <div class="form-group">
                            <label for="calendarDate">Date :</label>
                            <input type="date" id="calendarDate" required>
                        </div>
                        <div class="form-group">
                            <label for="calendarTime">Heure :</label>
                            <input type="time" id="calendarTime" required>
                        </div>
                        <div class="form-group">
                            <label for="calendarDescription">Description (optionnel) :</label>
                            <textarea id="calendarDescription" placeholder="Description de l'√©v√©nement"></textarea>
                        </div>
                    `;
                    break;
                case 'payment':
                    html = `
                        <div class="form-group">
                            <label for="paymentType">Type de paiement :</label>
                            <select id="paymentType" required>
                                <option value="">S√©lectionner</option>
                                <option value="paypal">PayPal</option>
                                <option value="stripe">Stripe</option>
                                <option value="crypto">Cryptomonnaie</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentAmount">Montant :</label>
                            <input type="number" id="paymentAmount" step="0.01" placeholder="10.00" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentCurrency">Devise :</label>
                            <select id="paymentCurrency">
                                <option value="EUR">EUR</option>
                                <option value="USD">USD</option>
                                <option value="BTC">BTC</option>
                                <option value="ETH">ETH</option>
                            </select>
                        </div>
                    `;
                    break;
            }
            
            detailsDiv.innerHTML = html;
            detailsDiv.style.display = 'block';
            
            // Restore form values for interactive details
            setTimeout(() => {
                restoreFormValues();
            }, 100);
        }
        
        // Generate QR Code with improved error handling
        function generateQRCode() {
            // Save current form data
            saveFormData();
            
            // Collect form data
            const formData = collectFormData();
            
            if (!formData) {
                return; // Validation failed
            }
            
            // Show loading
            document.getElementById('content-config').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>G√©n√©ration du QR Code en cours...</p>
                </div>
            `;
            
                         // Prepare API call - Utiliser directement l'API statique
             const apiUrl = '/api/qr';
             const params = {
                 ...formData,
                 style: workflowState.style,
                 size: workflowState.quality?.size || 500,
                 errorCorrection: workflowState.quality?.errorCorrection || 'M',
                 foreground_color: workflowState.colors?.foreground || '#000000',
                 background_color: workflowState.colors?.background || '#FFFFFF'
             };
             
             // Add logo parameters if logo is selected
             if (workflowState.logo?.file) {
                 params.logo = workflowState.logo.file;
                 params.logo_size = workflowState.logo.size;
                 params.logo_position = workflowState.logo.position;
             }
            
            // Add auth token
            const authToken = getAuthToken();
            if (authToken) {
                params.auth_token = authToken;
            }
            
            console.log('Sending request to:', apiUrl);
            console.log('Parameters:', params);
            
            // Make API call
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(params)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    displayQRResult(data.qr_code, data.qr_id);
                } else {
                    throw new Error(data.error || 'Erreur inconnue lors de la g√©n√©ration');
                }
            })
            .catch(error => {
                console.error('Erreur d√©taill√©e:', error);
                
                // Restore form after error
                loadContentConfiguration();
                
                // Show user-friendly error message
                let errorMessage = 'Erreur lors de la g√©n√©ration du QR Code';
                if (error.message.includes('HTTP error')) {
                    errorMessage = 'Erreur de connexion au serveur. Veuillez r√©essayer.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Impossible de contacter le serveur. V√©rifiez votre connexion.';
                } else {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            });
        }
        
        function collectFormData() {
            const data = {};
            
            switch (workflowState.target) {
                case 'web':
                    data.url = document.getElementById('webUrl')?.value || '';
                    data.title = document.getElementById('webTitle')?.value || '';
                    if (!data.url) {
                        alert('Veuillez saisir une URL');
                        return null;
                    }
                    break;
                    
                case 'social':
                    data.platform = document.getElementById('socialPlatform')?.value || '';
                    data.username = document.getElementById('socialUsername')?.value || '';
                    if (!data.platform || !data.username) {
                        alert('Veuillez s√©lectionner une plateforme et saisir un nom d\'utilisateur');
                        return null;
                    }
                    break;
                    
                case 'contact':
                    data.type = document.getElementById('contactType')?.value || '';
                    if (!data.type) {
                        alert('Veuillez s√©lectionner un type de contact');
                        return null;
                    }
                    
                    // Collect contact-specific data
                    switch (data.type) {
                        case 'email':
                            data.email = document.getElementById('contactEmail')?.value || '';
                            data.subject = document.getElementById('contactSubject')?.value || '';
                            if (!data.email) {
                                alert('Veuillez saisir une adresse email');
                                return null;
                            }
                            break;
                        case 'phone':
                            data.phone = document.getElementById('contactPhone')?.value || '';
                            if (!data.phone) {
                                alert('Veuillez saisir un num√©ro de t√©l√©phone');
                                return null;
                            }
                            break;
                        case 'sms':
                            data.phone = document.getElementById('contactSmsPhone')?.value || '';
                            data.message = document.getElementById('contactSmsMessage')?.value || '';
                            if (!data.phone) {
                                alert('Veuillez saisir un num√©ro de t√©l√©phone');
                                return null;
                            }
                            break;
                        case 'vcard':
                            data.name = document.getElementById('vcardName')?.value || '';
                            data.phone = document.getElementById('vcardPhone')?.value || '';
                            data.email = document.getElementById('vcardEmail')?.value || '';
                            data.company = document.getElementById('vcardCompany')?.value || '';
                            if (!data.name || !data.phone || !data.email) {
                                alert('Veuillez saisir au moins le nom, t√©l√©phone et email');
                                return null;
                            }
                            break;
                    }
                    break;
                    
                case 'media':
                    data.type = document.getElementById('mediaType')?.value || '';
                    data.url = document.getElementById('mediaUrl')?.value || '';
                    if (!data.type || !data.url) {
                        alert('Veuillez s√©lectionner un type de m√©dia et saisir une URL');
                        return null;
                    }
                    break;
                    
                case 'interactive':
                    data.type = document.getElementById('interactiveType')?.value || '';
                    if (!data.type) {
                        alert('Veuillez s√©lectionner un type d\'action');
                        return null;
                    }
                    
                    // Collect interactive-specific data
                    switch (data.type) {
                        case 'wifi':
                            data.ssid = document.getElementById('wifiSSID')?.value || '';
                            data.password = document.getElementById('wifiPassword')?.value || '';
                            data.encryption = document.getElementById('wifiEncryption')?.value || 'WPA';
                            if (!data.ssid) {
                                alert('Veuillez saisir le nom du r√©seau Wi-Fi');
                                return null;
                            }
                            break;
                        case 'geo':
                            data.latitude = document.getElementById('geoLatitude')?.value || '';
                            data.longitude = document.getElementById('geoLongitude')?.value || '';
                            data.label = document.getElementById('geoLabel')?.value || '';
                            if (!data.latitude || !data.longitude) {
                                alert('Veuillez saisir les coordonn√©es GPS');
                                return null;
                            }
                            break;
                        case 'calendar':
                            data.title = document.getElementById('calendarTitle')?.value || '';
                            data.date = document.getElementById('calendarDate')?.value || '';
                            data.time = document.getElementById('calendarTime')?.value || '';
                            data.description = document.getElementById('calendarDescription')?.value || '';
                            if (!data.title || !data.date || !data.time) {
                                alert('Veuillez saisir le titre, la date et l\'heure');
                                return null;
                            }
                            break;
                        case 'payment':
                            data.paymentType = document.getElementById('paymentType')?.value || '';
                            data.amount = document.getElementById('paymentAmount')?.value || '';
                            data.currency = document.getElementById('paymentCurrency')?.value || 'EUR';
                            if (!data.paymentType || !data.amount) {
                                alert('Veuillez s√©lectionner un type de paiement et saisir un montant');
                                return null;
                            }
                            break;
                    }
                    break;
            }
            
            return data;
        }
        
        function displayQRResult(qrCodeData, qrId) {
            // Display QR code in the result section
            const resultDiv = document.getElementById('qrResult');
            if (resultDiv) {
                resultDiv.innerHTML = `
                    <div class="qr-code">
                        <img src="data:image/png;base64,${qrCodeData}" alt="QR Code g√©n√©r√©">
                    </div>
                    <p><strong>QR Code statique g√©n√©r√© avec succ√®s !</strong></p>
                    ${qrId ? `<p>ID: ${qrId}</p>` : ''}
                `;
                
                // Store QR ID for download
                window.currentQRId = qrId;
                
                // Show the result section by making it active
                showStep('result');
            } else {
                console.error('Result div not found');
                // Fallback: show in step 4
                const contentConfig = document.getElementById('content-config');
                if (contentConfig) {
                    contentConfig.innerHTML = `
                        <div class="result">
                            <div class="qr-code">
                                <img src="data:image/png;base64,${qrCodeData}" alt="QR Code g√©n√©r√©">
                            </div>
                            <p><strong>QR Code statique g√©n√©r√© avec succ√®s !</strong></p>
                            ${qrId ? `<p>ID: ${qrId}</p>` : ''}
                            <div class="action-buttons">
                                <button class="action-btn" onclick="downloadQR()">üì• T√©l√©charger</button>
                                <button class="action-btn success" onclick="shareQR()">üì§ Partager</button>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        function downloadQR() {
            if (!window.currentQRId) {
                alert('Aucun QR Code √† t√©l√©charger');
                return;
            }
            
            const authToken = getAuthToken();
            fetch(`/api/dynamic/qr/${window.currentQRId}/download`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qr-code-${window.currentQRId}.png`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Erreur de t√©l√©chargement:', error);
                alert('Erreur lors du t√©l√©chargement');
            });
        }
        
        function shareQR() {
            if (navigator.share) {
                navigator.share({
                    title: 'Mon QR Code',
                    text: 'QR Code g√©n√©r√© avec IAHome',
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Lien copi√© dans le presse-papiers !');
                });
            }
        }
        
                 function resetWorkflow() {
             // Reset state
             workflowState = {
                 style: null,
                 colors: {
                     foreground: '#000000',
                     background: '#FFFFFF',
                     scheme: 'custom'
                 },
                 target: null,
                 type: null,
                 quality: {
                     size: 500,
                     errorCorrection: 'M',
                     format: 'PNG'
                 },
                 logo: {
                     file: null,
                     size: 15,
                     position: 'center'
                 },
                 content: {}
             };
            
            // Reset UI
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Show first step
            showStep(1);
        }
        
                 // Management functions
         function loadDynamicQRCodes() {
             const authToken = getAuthToken();
             const listDiv = document.getElementById('qrCodesList');
             
             listDiv.innerHTML = `
                 <div class="loading">
                     <div class="spinner"></div>
                     <p>Chargement des QR codes...</p>
                 </div>
             `;
             
             fetch('/api/dynamic/qr', {
                 headers: {
                     'Authorization': `Bearer ${authToken}`
                 }
             })
             .then(response => {
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 return response.json();
             })
                           .then(data => {
                  console.log('QR codes loaded:', data);
                  // Check if data has the expected structure
                  if (data.success && data.qr_codes) {
                      // Convert qr_codes object to array if needed
                      let qrCodesArray;
                      if (Array.isArray(data.qr_codes)) {
                          qrCodesArray = data.qr_codes;
                      } else if (typeof data.qr_codes === 'object') {
                          // Convert object to array
                          qrCodesArray = Object.values(data.qr_codes);
                      } else {
                          qrCodesArray = [];
                      }
                      displayQRCodesList(qrCodesArray);
                      
                      // Update user stats
                      const totalQRCodes = qrCodesArray.length;
                      const totalScans = qrCodesArray.reduce((sum, qr) => sum + (qr.scans || 0), 0);
                      const avgScans = totalQRCodes > 0 ? Math.round(totalScans / totalQRCodes) : 0;

                  } else {
                      displayQRCodesList([]);
                      
                  }
              })
             .catch(error => {
                 console.error('Erreur lors du chargement:', error);
                 listDiv.innerHTML = `
                     <div class="no-qr-codes">
                         <p>Erreur lors du chargement des QR codes</p>
                         <button class="nav-button" onclick="loadDynamicQRCodes()">R√©essayer</button>
                     </div>
                 `;
             });
         }
         
         function displayQRCodesList(qrCodes) {
             const listDiv = document.getElementById('qrCodesList');
             
             if (!qrCodes || qrCodes.length === 0) {
                 listDiv.innerHTML = `
                     <div class="no-qr-codes">
                         <p>Aucun QR code dynamique trouv√©</p>
                         <p>Cr√©ez votre premier QR code dynamique !</p>
                     </div>
                 `;
                 return;
             }
             
             let html = '';
             qrCodes.forEach(qrCode => {
                 html += `
                     <div class="qr-code-item" id="qr-item-${qrCode.qr_id}">
                         <div class="qr-code-header">
                             <div class="qr-code-title">${qrCode.name || 'QR Code sans nom'}</div>
                             <div class="qr-code-id">ID: ${qrCode.qr_id}</div>
                         </div>
                         <div class="qr-code-content">
                             <div class="qr-code-info">
                                                                   <div><strong>URL de destination:</strong></div>
                                  <a href="${qrCode.url}" target="_blank" class="qr-code-url">${qrCode.url}</a>
                                 <div><strong>URL de redirection:</strong></div>
                                 <a href="${qrCode.qr_url}" target="_blank" class="qr-code-url">${qrCode.qr_url}</a>
                                 <div><strong>Cr√©√© le:</strong> ${new Date(qrCode.created_at).toLocaleString('fr-FR')}</div>
                             </div>
                             <div class="qr-code-image">
                                 <img src="data:image/png;base64,${qrCode.qr_code}" alt="QR Code ${qrCode.qr_id}">
                             </div>
                         </div>
                         <div class="qr-code-actions">
                                                           <button class="qr-action-btn edit" onclick="editQRCode('${qrCode.qr_id}', '${qrCode.url}', '${qrCode.name || ''}')">
                                 ‚úèÔ∏è Modifier
                             </button>
                             <button class="qr-action-btn download" onclick="downloadSpecificQR('${qrCode.qr_id}')">
                                 üì• T√©l√©charger
                             </button>
                             <button class="qr-action-btn delete" onclick="deleteQRCode('${qrCode.qr_id}')">
                                 üóëÔ∏è Supprimer
                             </button>
                         </div>
                     </div>
                 `;
             });
             
             listDiv.innerHTML = html;
         }
         
         function editQRCode(qrId, currentUrl, currentName) {
             const itemDiv = document.getElementById(`qr-item-${qrId}`);
             const actionsDiv = itemDiv.querySelector('.qr-code-actions');
             
             const editForm = `
                 <div class="edit-form">
                     <div class="form-group">
                         <label for="edit-url-${qrId}">Nouvelle URL de destination:</label>
                         <input type="url" id="edit-url-${qrId}" value="${currentUrl}" required>
                     </div>
                     <div class="form-group">
                         <label for="edit-name-${qrId}">Nom (optionnel):</label>
                         <input type="text" id="edit-name-${qrId}" value="${currentName}">
                     </div>
                     <div class="edit-form-buttons">
                         <button class="qr-action-btn edit" onclick="saveQRCodeEdit('${qrId}')">
                             üíæ Sauvegarder
                         </button>
                         <button class="qr-action-btn" onclick="cancelQRCodeEdit('${qrId}')">
                             ‚ùå Annuler
                         </button>
                     </div>
                 </div>
             `;
             
             actionsDiv.innerHTML = editForm;
         }
         
         function saveQRCodeEdit(qrId) {
             const newUrl = document.getElementById(`edit-url-${qrId}`).value;
             const newName = document.getElementById(`edit-name-${qrId}`).value;
             const authToken = getAuthToken();
             
             if (!newUrl) {
                 alert('Veuillez saisir une URL valide');
                 return;
             }
             
             // Pr√©parer les param√®tres de personnalisation
             const params = {
                 url: newUrl,
                 name: newName,
                 foreground_color: workflowState.colors?.foreground || '#000000',
                 background_color: workflowState.colors?.background || '#FFFFFF',
                 logo_size: workflowState.logo?.size || 15,
                 logo_position: workflowState.logo?.position || 'center',
                 size: workflowState.quality?.size || 300,
                 margin: 4,
                 errorCorrection: workflowState.quality?.errorCorrection || 'M'
             };
             
             // Ajouter le logo si disponible
             if (workflowState.logo?.file) {
                 params.logo = workflowState.logo.file;
             }
             
             fetch(`/api/dynamic/qr/${qrId}`, {
                 method: 'PUT',
                 headers: {
                     'Content-Type': 'application/json',
                     'Authorization': `Bearer ${authToken}`
                 },
                 body: JSON.stringify(params)
             })
             .then(response => {
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 return response.json();
             })
             .then(data => {
                 console.log('QR code updated:', data);
                 
                 // Mettre √† jour l'affichage du QR code si un nouveau QR code est retourn√©
                 if (data.qr_code) {
                     const qrImageElement = document.getElementById(`qr-image-${qrId}`);
                     if (qrImageElement) {
                         qrImageElement.src = `data:image/png;base64,${data.qr_code}`;
                     }
                 }
                 
                 alert('QR code mis √† jour avec succ√®s !');
                 loadDynamicQRCodes(); // Reload the list
             })
             .catch(error => {
                 console.error('Erreur lors de la mise √† jour:', error);
                 alert('Erreur lors de la mise √† jour du QR code');
             });
         }
         
         function cancelQRCodeEdit(qrId) {
             loadDynamicQRCodes(); // Reload to restore original state
         }
         
         function deleteQRCode(qrId) {
             if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce QR code ? Cette action est irr√©versible.')) {
                 return;
             }
             
             const authToken = getAuthToken();
             
             fetch(`/api/dynamic/qr/${qrId}`, {
                 method: 'DELETE',
                 headers: {
                     'Authorization': `Bearer ${authToken}`
                 }
             })
             .then(response => {
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 return response.json();
             })
             .then(data => {
                 console.log('QR code deleted:', data);
                 alert('QR code supprim√© avec succ√®s !');
                 loadDynamicQRCodes(); // Reload the list
             })
             .catch(error => {
                 console.error('Erreur lors de la suppression:', error);
                 alert('Erreur lors de la suppression du QR code');
             });
         }
         
         function downloadSpecificQR(qrId) {
             const authToken = getAuthToken();
             
             fetch(`/api/dynamic/qr/${qrId}/download`, {
                 headers: {
                     'Authorization': `Bearer ${authToken}`
                 }
             })
             .then(response => response.blob())
             .then(blob => {
                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `qr-code-${qrId}.png`;
                 document.body.appendChild(a);
                 a.click();
                 window.URL.revokeObjectURL(url);
                 document.body.removeChild(a);
             })
             .catch(error => {
                 console.error('Erreur de t√©l√©chargement:', error);
                 alert('Erreur lors du t√©l√©chargement');
             });
                   }
          
              const statsDiv = document.getElementById('statisticsContent');
              
              if (!qrCodes || qrCodes.length === 0) {
                  statsDiv.innerHTML = `
                      <div class="no-stats">
                          <p>Aucun QR code trouv√©</p>
                          <p>Cr√©ez votre premier QR code pour voir les statistiques !</p>
                      </div>
                  `;
                  return;
              }
              
              // Calculate statistics
              const totalQRs = qrCodes.length;
              const totalScans = qrCodes.reduce((sum, qr) => sum + (qr.scans || 0), 0);
              const avgScans = totalQRs > 0 ? Math.round(totalScans / totalQRs) : 0;
              const mostScanned = qrCodes.reduce((max, qr) => 
                  (qr.scans || 0) > (max.scans || 0) ? qr : max, qrCodes[0]);
              
              let html = `
                  <div class="stats-grid">
                      <div class="stat-card">
                          <div class="stat-number">${totalQRs}</div>
                          <div class="stat-label">QR Codes cr√©√©s</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${totalScans}</div>
                          <div class="stat-label">Scans totaux</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${avgScans}</div>
                          <div class="stat-label">Moyenne par QR</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${mostScanned ? (mostScanned.scans || 0) : 0}</div>
                          <div class="stat-label">Plus scann√©</div>
                      </div>
                  </div>
                  
                  <div class="stats-table">
                      <table>
                          <thead>
                              <tr>
                                  <th>QR Code</th>
                                  <th>URL de destination</th>
                                  <th>Scans</th>
                                  <th>Dernier scan</th>
                                  <th>Cr√©√© le</th>
                              </tr>
                          </thead>
                          <tbody>
              `;
              
              qrCodes.forEach(qrCode => {
                  const lastScan = qrCode.last_scan ? new Date(qrCode.last_scan).toLocaleString('fr-FR') : 'Jamais';
                  const createdDate = new Date(qrCode.created_at).toLocaleString('fr-FR');
                  
                  html += `
                      <tr>
                          <td class="qr-name">${qrCode.name || 'QR Code sans nom'}</td>
                          <td>
                              <a href="${qrCode.url}" target="_blank" class="qr-code-url">${qrCode.url}</a>
                          </td>
                          <td class="scan-count">${qrCode.scans || 0}</td>
                          <td class="last-scan">${lastScan}</td>
                          <td class="last-scan">${createdDate}</td>
                      </tr>
                  `;
              });
              
              html += `
                          </tbody>
                      </table>
                  </div>
              `;
              
              statsDiv.innerHTML = html;
          }
          
        // Load user email from JWT token via API
        function loadUserEmail() {
            const authToken = getAuthToken(); 
            if (authToken) {
                // Validate token via API and get user info
                fetch('/api/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: authToken })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.userEmail) {
                        document.getElementById('user-email').textContent = data.userEmail;
                    } else {
                        document.getElementById('user-email').textContent = 'Utilisateur IAHome';
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la validation du token:', error);
                    document.getElementById('user-email').textContent = 'Utilisateur IAHome';
                });
            } else {
                document.getElementById('user-email').textContent = 'Non connect√©';
            }
        }

        // Load user statistics
        function loadUserStats() {
            const authToken = getAuthToken();
            if (!authToken) return;

            fetch('/api/dynamic/qr', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.qr_codes) {
                    const qrCodes = Object.values(data.qr_codes);
                    const totalQRCodes = qrCodes.length;
                    const totalScans = qrCodes.reduce((sum, qr) => sum + (qr.scans || 0), 0);
                    const avgScans = totalQRCodes > 0 ? Math.round(totalScans / totalQRCodes) : 0;

                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des statistiques:', error);
            });
        }

        // Initialize workflow and stats
        document.addEventListener('DOMContentLoaded', function() {
            showStep(1);
            initializeAuth(); // Initialize authentication first
            loadUserEmail();
            loadUserStats();
        });
    </script>
</body>
</html>
