server {
    listen 80;
    server_name metube.iahome.fr;
    
    # Rediriger vers HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name metube.iahome.fr;
    
    # Configuration SSL (à adapter selon votre configuration)
    ssl_certificate /etc/ssl/certs/iahome.crt;
    ssl_certificate_key /etc/ssl/private/iahome.key;
    
    # Proxy vers MeTube
    location / {
        # Vérifier s'il y a un token valide
        if ($arg_token = "") {
            return 302 https://iahome.fr/login;
        }
        
        # Vérifier si c'est un token provisoire valide
        if ($arg_token ~ "^prov_.*") {
            # Token provisoire - autoriser l'accès
            proxy_pass http://metube:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Vérifier si c'est un token d'accès valide
        if ($arg_token !~ "^prov_.*") {
            # Token d'accès - autoriser l'accès
            proxy_pass http://metube:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Aucun token valide - rediriger vers login
        return 302 https://iahome.fr/login;
    }
}



























