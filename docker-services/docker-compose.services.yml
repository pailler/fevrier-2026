version: '3.8'

services:
  # Service Stirling-PDF
  stirling-pdf:
    image: frooodle/s-pdf:latest
    container_name: stirling-pdf
    restart: unless-stopped
    ports:
      - "8081:8080"  # Port principal de Stirling-PDF
    environment:
      - DOCKER_ENABLE_SECURITY=false  # Désactiver la sécurité pour un accès sans authentification
      - DOCKER_ENABLE_UPDATE_CHECK=false  # Désactiver les vérifications de mise à jour
      - DOCKER_ENABLE_CORS=true  # Activer CORS pour l'intégration web
      - DOCKER_ENABLE_LOGGING=true  # Activer les logs
      - DOCKER_ENABLE_DEBUG=false  # Désactiver le mode debug en production
    volumes:
      - ./pdf-data:/usr/share/tesseract-ocr/4.00/tessdata  # Données OCR
      - ./pdf-uploads:/usr/share/tesseract-ocr/4.00/tessdata  # Dossier d'upload
      - ./pdf-temp:/tmp  # Dossier temporaire
    networks:
      - services-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stirling-pdf.rule=Host(`pdf.iahome.fr`)"
      - "traefik.http.routers.stirling-pdf.entrypoints=websecure"
      - "traefik.http.routers.stirling-pdf.tls=true"
      - "traefik.http.services.stirling-pdf.loadbalancer.server.port=8080"
      - "traefik.http.routers.stirling-pdf-http.rule=Host(`pdf.iahome.fr`)"
      - "traefik.http.routers.stirling-pdf-http.entrypoints=web"
      - "traefik.http.routers.stirling-pdf-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service MeTube
  metube:
    image: alexta69/metube:latest
    container_name: metube
    restart: unless-stopped
    ports:
      - "8082:8081"  # Port pour MeTube
    volumes:
      - ./metube-downloads:/downloads
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.metube.rule=Host(`metube.iahome.fr`)"
      - "traefik.http.routers.metube.entrypoints=websecure"
      - "traefik.http.routers.metube.tls=true"
      - "traefik.http.services.metube.loadbalancer.server.port=8081"
      - "traefik.http.routers.metube-http.rule=Host(`metube.iahome.fr`)"
      - "traefik.http.routers.metube-http.entrypoints=web"
      - "traefik.http.routers.metube-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service LibreSpeed (test de vitesse)
  librespeed:
    image: linuxserver/librespeed:latest
    container_name: librespeed
    restart: unless-stopped
    ports:
      - "8083:80"  # Port pour LibreSpeed
    environment:
      - TITLE=LibreSpeed Regispailler
      - TELEMETRY=false
      - ENABLE_IDLE_MODE=true
      - REDIRECT_HTTPS=false
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.librespeed.rule=Host(`librespeed.iahome.fr`)"
      - "traefik.http.routers.librespeed.entrypoints=websecure"
      - "traefik.http.routers.librespeed.tls=true"
      - "traefik.http.services.librespeed.loadbalancer.server.port=80"
      - "traefik.http.routers.librespeed-http.rule=Host(`librespeed.iahome.fr`)"
      - "traefik.http.routers.librespeed-http.entrypoints=web"
      - "traefik.http.routers.librespeed-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service PSITransfer
  psitransfer:
    image: psitrax/psitransfer:latest
    container_name: psitransfer
    restart: unless-stopped
    ports:
      - "8084:3000"  # Port pour PSITransfer
    environment:
      - PSITRANSFER_ADMIN_EMAIL=admin@iahome.fr
      - PSITRANSFER_SITE_NAME=IAHome Transfer
    volumes:
      - ./psitransfer-data:/var/lib/psitransfer
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.psitransfer.rule=Host(`psitransfer.iahome.fr`)"
      - "traefik.http.routers.psitransfer.entrypoints=websecure"
      - "traefik.http.routers.psitransfer.tls=true"
      - "traefik.http.services.psitransfer.loadbalancer.server.port=3000"
      - "traefik.http.routers.psitransfer-http.rule=Host(`psitransfer.iahome.fr`)"
      - "traefik.http.routers.psitransfer-http.entrypoints=web"
      - "traefik.http.routers.psitransfer-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service Universal Converter
  universal-converter:
    build:
      context: ./universal-converter
      dockerfile: Dockerfile
    container_name: universal-converter
    restart: unless-stopped
    ports:
      - "8096:8080"  # Port pour Universal Converter
    environment:
      - IAHOME_API_URL=http://host.docker.internal:3000
    volumes:
      - ./universal-converter/uploads:/app/uploads
      - ./universal-converter/downloads:/app/downloads
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.universal-converter.rule=Host(`converter.iahome.fr`)"
      - "traefik.http.routers.universal-converter.entrypoints=websecure"
      - "traefik.http.routers.universal-converter.tls=true"
      - "traefik.http.services.universal-converter.loadbalancer.server.port=8080"
      - "traefik.http.routers.universal-converter-http.rule=Host(`converter.iahome.fr`)"
      - "traefik.http.routers.universal-converter-http.entrypoints=web"
      - "traefik.http.routers.universal-converter-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service StableDiffusion
  stablediffusion:
    image: pytorch/pytorch:latest
    container_name: stablediffusion
    restart: unless-stopped
    ports:
      - "8085:8080"  # Port pour StableDiffusion
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./stablediffusion-data:/app
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stablediffusion.rule=Host(`stablediffusion.iahome.fr`)"
      - "traefik.http.routers.stablediffusion.entrypoints=websecure"
      - "traefik.http.routers.stablediffusion.tls=true"
      - "traefik.http.services.stablediffusion.loadbalancer.server.port=8080"
      - "traefik.http.routers.stablediffusion-http.rule=Host(`stablediffusion.iahome.fr`)"
      - "traefik.http.routers.stablediffusion-http.entrypoints=web"
      - "traefik.http.routers.stablediffusion-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service RuinedFooocus
  ruinedfooocus:
    image: python:3.9-slim
    container_name: ruinedfooocus
    restart: unless-stopped
    ports:
      - "8087:8080"  # Port pour RuinedFooocus
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./ruinedfooocus-data:/app
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ruinedfooocus.rule=Host(`ruinedfooocus.iahome.fr`)"
      - "traefik.http.routers.ruinedfooocus.entrypoints=websecure"
      - "traefik.http.routers.ruinedfooocus.tls=true"
      - "traefik.http.services.ruinedfooocus.loadbalancer.server.port=8080"
      - "traefik.http.routers.ruinedfooocus-http.rule=Host(`ruinedfooocus.iahome.fr`)"
      - "traefik.http.routers.ruinedfooocus-http.entrypoints=web"
      - "traefik.http.routers.ruinedfooocus-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service ComfyUI
  comfyui:
    image: yanwk/comfyui:latest
    container_name: comfyui
    restart: unless-stopped
    ports:
      - "8088:8188"  # Port pour ComfyUI
    environment:
      - CLI_ARGS=--listen --port 8188 --enable-cors-header
    volumes:
      - ./comfyui-models:/app/models
      - ./comfyui-outputs:/app/output
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.comfyui.rule=Host(`comfyui.iahome.fr`)"
      - "traefik.http.routers.comfyui.entrypoints=websecure"
      - "traefik.http.routers.comfyui.tls=true"
      - "traefik.http.services.comfyui.loadbalancer.server.port=8188"
      - "traefik.http.routers.comfyui-http.rule=Host(`comfyui.iahome.fr`)"
      - "traefik.http.routers.comfyui-http.entrypoints=web"
      - "traefik.http.routers.comfyui-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service SDNext
  sdnext:
    image: ghcr.io/automatic1111/stable-diffusion-webui:latest
    container_name: sdnext
    restart: unless-stopped
    ports:
      - "8089:7860"  # Port pour SDNext
    environment:
      - CLI_ARGS=--listen --port 7860 --enable-cors-header
    volumes:
      - ./sdnext-models:/app/models
      - ./sdnext-outputs:/app/output
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sdnext.rule=Host(`sdnext.iahome.fr`)"
      - "traefik.http.routers.sdnext.entrypoints=websecure"
      - "traefik.http.routers.sdnext.tls=true"
      - "traefik.http.services.sdnext.loadbalancer.server.port=7860"
      - "traefik.http.routers.sdnext-http.rule=Host(`sdnext.iahome.fr`)"
      - "traefik.http.routers.sdnext-http.entrypoints=web"
      - "traefik.http.routers.sdnext-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service Invoke
  invoke:
    image: invokeai/invokeai:latest
    container_name: invoke
    restart: unless-stopped
    ports:
      - "8090:9090"  # Port pour Invoke
    environment:
      - INVOKEAI_ROOT=/app/invokeai
    volumes:
      - ./invoke-models:/app/invokeai/models
      - ./invoke-outputs:/app/invokeai/outputs
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.invoke.rule=Host(`invoke.iahome.fr`)"
      - "traefik.http.routers.invoke.entrypoints=websecure"
      - "traefik.http.routers.invoke.tls=true"
      - "traefik.http.services.invoke.loadbalancer.server.port=9090"
      - "traefik.http.routers.invoke-http.rule=Host(`invoke.iahome.fr`)"
      - "traefik.http.routers.invoke-http.entrypoints=web"
      - "traefik.http.routers.invoke-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # Service QR Codes
  qrcodes:
    build: ../qr-code-service
    container_name: qrcodes
    restart: unless-stopped
    ports:
      - "8091:7005"  # Port pour QR Codes
    environment:
      - PYTHONUNBUFFERED=1
      - FLASK_APP=qr_service.py
      - FLASK_ENV=production
      - IAHOME_JWT_SECRET=iahome-jwt-secret-2024-production-secure-key
      - DATABASE_URL=postgresql://qrcode_user:qrcode_password@postgres:5432/qrcode_db
    volumes:
      - C:\Users\AAA\Documents\iahome\qr-code-service:/app
      - C:\Users\AAA\Documents\iahome\qrcodes-data:/app/qr_codes
    working_dir: /app
    command: ["python", "qr_service.py"]
    networks:
      - services-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qrcodes.rule=Host(`qrcodes.iahome.fr`)"
      - "traefik.http.routers.qrcodes.entrypoints=websecure"
      - "traefik.http.routers.qrcodes.tls=true"
      - "traefik.http.services.qrcodes.loadbalancer.server.port=7005"
      - "traefik.http.routers.qrcodes-http.rule=Host(`qrcodes.iahome.fr`)"
      - "traefik.http.routers.qrcodes-http.entrypoints=web"
      - "traefik.http.routers.qrcodes-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"



  # Service Polr (raccourcissement d'URL)
  polr:
    image: ajanvier/polr:latest
    container_name: polr
    restart: unless-stopped
    ports:
      - "8086:80"  # Port pour Polr
    environment:
      - DB_HOST=polr-db
      - DB_DATABASE=polr
      - DB_USERNAME=polr
      - DB_PASSWORD=polr_password
      - APP_NAME=QRCode Regispailler
      - APP_ADDRESS=https://qrcode.iahome.fr
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=admin123
      - SETTING_PUBLIC_INTERFACE=true
      - SETTING_SHORTEN_PERMISSION=true
      - SETTING_INDEX_REDIRECT=https://qrcode.iahome.fr
    volumes:
      - ./polr-data:/app/.env
    networks:
      - services-network
    depends_on:
      - polr-db

  # Base de données pour Polr
  polr-db:
    image: mysql:5.7
    container_name: polr-db
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=polr
      - MYSQL_USER=polr
      - MYSQL_PASSWORD=polr_password
      - MYSQL_ROOT_PASSWORD=root_password
    volumes:
      - ./polr-db-data:/var/lib/mysql
    networks:
      - services-network


networks:
  services-network:
    driver: bridge

volumes:
  pdf-data:
  pdf-uploads:
  pdf-temp:
  metube-downloads:
  psitransfer-data:
  polr-data:
  polr-db-data:
