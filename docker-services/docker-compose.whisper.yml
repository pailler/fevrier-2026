# Configuration Whisper IA - Production

services:
  # Service Whisper API - Production
  whisper-api:
    image: onerahmet/openai-whisper-asr-webservice:latest
    container_name: whisper-api-prod
    restart: unless-stopped
    ports:
      - "8092:9000"
    env_file:
      - env.whisper.production
    environment:
      - ASR_ENGINE=openai_whisper
      - ASR_MODEL_PATH=/app/models
      - ASR_MODEL_INITIAL_PROMPT=
      - ASR_MODEL_PREFIX=
      - ASR_MODEL_SUFFIX=
      - ASR_MODEL_MAX_LENGTH=448
      - ASR_MODEL_WORD_TIMESTAMPS=false
      - ASR_MODEL_PREPEND_PUNCTUATION=true
      - ASR_MODEL_APPEND_PUNCTUATION=true
      - ASR_MODEL_WORD_LEVEL_TIMESTAMPS=false
      - ASR_MODEL_VERBOSE=false
      - ASR_MODEL_DEBUG=false
      - ASR_MODEL_TRUNCATE=false
      - NODE_ENV=production
      - DOCKER_ENABLE_LOGGING=true
      - DOCKER_ENABLE_DEBUG=false
      - DOCKER_ENABLE_SECURITY=true
      - DOCKER_ENABLE_UPDATE_CHECK=false
      - DOCKER_ENABLE_CORS=true
    volumes:
      - whisper-models:/app/models
      - whisper-uploads:/app/uploads
      - whisper-outputs:/app/outputs
    networks:
      - whisper-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Interface web moderne pour Whisper - Production
  whisper-webui:
    image: nginx:alpine
    container_name: whisper-webui-prod
    restart: unless-stopped
    ports:
      - "8093:80"
    volumes:
      - ./whisper-webui:/usr/share/nginx/html:ro
      - ./nginx/whisper.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - whisper-network
    depends_on:
      - whisper-api
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Service OCR pour reconnaissance de texte dans les images
  whisper-ocr:
    image: python:3.11-slim
    container_name: whisper-ocr-prod
    restart: unless-stopped
    ports:
      - "8094:8080"
    environment:
      - PYTHONUNBUFFERED=1
      - TESSDATA_PREFIX=/usr/share/tesseract-ocr/4.00/tessdata
    volumes:
      - ./whisper-ocr:/app
      - whisper-ocr-data:/app/data
      - whisper-ocr-uploads:/app/uploads
      - whisper-ocr-outputs:/app/outputs
    networks:
      - whisper-network
    command: >
      sh -c "apt-get update && 
             apt-get install -y tesseract-ocr tesseract-ocr-fra curl && 
             pip install fastapi uvicorn python-multipart pillow pytesseract && 
             python /app/ocr_server.py"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Service de transcription vidéo (utilise Whisper + FFmpeg)
  whisper-video:
    image: onerahmet/openai-whisper-asr-webservice:latest
    container_name: whisper-video-prod
    restart: unless-stopped
    ports:
      - "8095:9000"
    env_file:
      - env.whisper.production
    environment:
      - ASR_ENGINE=openai_whisper
      - ASR_MODEL_PATH=/app/models
      - ASR_MODEL_INITIAL_PROMPT=
      - ASR_MODEL_PREFIX=
      - ASR_MODEL_SUFFIX=
      - ASR_MODEL_MAX_LENGTH=448
      - ASR_MODEL_WORD_TIMESTAMPS=true
      - ASR_MODEL_PREPEND_PUNCTUATION=true
      - ASR_MODEL_APPEND_PUNCTUATION=true
      - ASR_MODEL_WORD_LEVEL_TIMESTAMPS=true
      - ASR_MODEL_VERBOSE=false
      - ASR_MODEL_DEBUG=false
      - ASR_MODEL_TRUNCATE=false
      - NODE_ENV=production
      - DOCKER_ENABLE_LOGGING=true
      - DOCKER_ENABLE_DEBUG=false
      - DOCKER_ENABLE_SECURITY=true
      - DOCKER_ENABLE_UPDATE_CHECK=false
      - DOCKER_ENABLE_CORS=true
      - VIDEO_PROCESSING=true
      - FFMPEG_ENABLED=true
    volumes:
      - whisper-video-models:/app/models
      - whisper-video-uploads:/app/uploads
      - whisper-video-outputs:/app/outputs
    networks:
      - whisper-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Cloudflared tunnel pour sécurisation - Production
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: whisper-cloudflared-prod
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token eyJhIjoiOWJhNDI5NGFhNzg3ZTY3YzMzNWM3MTg3NmMxMGFmMjEiLCJ0IjoiMWRiY2ZiNzQtNDI4Yi00ZGMxLTg4YTYtNzc1NjVhOThkOGYwIiwicyI6Ik9EYzNabUUxWVRrdE1URTBOaTAwTVRnekxUazVOVGt0WXpBeE5HVTNOekJtTm1ZeiJ9
    environment:
      - TUNNEL_TOKEN=eyJhIjoiOWJhNDI5NGFhNzg3ZTY3YzMzNWM3MTg3NmMxMGFmMjEiLCJ0IjoiMWRiY2ZiNzQtNDI4Yi00ZGMxLTg4YTYtNzc1NjVhOThkOGYwIiwicyI6Ik9EYzNabUUxWVRrdE1URTBOaTAwTVRnekxUazVOVGt0WXpBeE5HVTNOekJtTm1ZeiJ9
    networks:
      - whisper-network
    depends_on:
      - whisper-api
      - whisper-webui
      - whisper-ocr
      - whisper-video
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

networks:
  whisper-network:
    driver: bridge

volumes:
  whisper-models:
  whisper-uploads:
  whisper-outputs:
  whisper-ocr-data:
  whisper-ocr-uploads:
  whisper-ocr-outputs:
  whisper-video-models:
  whisper-video-uploads:
  whisper-video-outputs:
