<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Int√©gration LibreSpeed - AdamHome</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #718096;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #4a5568;
        }

        .status-value {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-warning {
            background: #fef5e7;
            color: #744210;
        }

        .access-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }

        .access-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .access-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .info-box {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .info-title {
            font-weight: 600;
            color: #2b6cb0;
            margin-bottom: 8px;
        }

        .info-text {
            color: #2c5282;
            font-size: 14px;
            line-height: 1.5;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #4a5568;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üöÄ</div>
        <h1>Test LibreSpeed</h1>
        <p class="subtitle">Int√©gration avec les m√™mes conditions d'acc√®s que /encours</p>

        <div class="status-card">
            <div class="status-item">
                <span class="status-label">Session utilisateur</span>
                <span class="status-value status-warning" id="session-status">V√©rification...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Module visible</span>
                <span class="status-value status-warning" id="module-status">V√©rification...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Acc√®s valide</span>
                <span class="status-value status-warning" id="access-status">V√©rification...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Origine autoris√©e</span>
                <span class="status-value status-warning" id="origin-status">V√©rification...</span>
            </div>
        </div>

        <button class="access-button" id="access-btn" onclick="accessLibreSpeed()">
            <span id="btn-text">Acc√©der √† LibreSpeed</span>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>V√©rification en cours...</span>
            </div>
        </button>

        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <div class="info-box">
            <div class="info-title">‚ÑπÔ∏è Conditions d'acc√®s</div>
            <div class="info-text">
                Cette page reproduit les m√™mes v√©rifications que la page /encours :<br>
                ‚Ä¢ Session utilisateur active<br>
                ‚Ä¢ Module LibreSpeed visible dans /encours<br>
                ‚Ä¢ Tokens d'acc√®s valides et non expir√©s<br>
                ‚Ä¢ Origine de la requ√™te autoris√©e (iahome.fr)<br>
                ‚Ä¢ Redirection vers librespeed.adamhome.fr
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isChecking = false;
        let sessionData = null;

        // Fonction pour mettre √† jour le statut
        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-value status-${status}`;
            element.textContent = text;
        }

        // Fonction pour afficher un message
        function showMessage(type, message) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            } else if (type === 'success') {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }
        }

        // Fonction pour v√©rifier la session utilisateur
        async function checkUserSession() {
            try {
                // Simuler la v√©rification de session (√† adapter selon votre syst√®me)
                const response = await fetch('/api/auth/session', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    sessionData = await response.json();
                    updateStatus('session-status', 'success', 'Connect√©');
                    return true;
                } else {
                    updateStatus('session-status', 'error', 'Non connect√©');
                    return false;
                }
            } catch (error) {
                console.error('Erreur v√©rification session:', error);
                updateStatus('session-status', 'error', 'Erreur');
                return false;
            }
        }

        // Fonction pour v√©rifier si le module est visible dans /encours
        async function checkModuleInEncours() {
            try {
                if (!sessionData?.user?.id) {
                    updateStatus('module-status', 'error', 'Pas de session');
                    return false;
                }

                // Simuler la v√©rification du module dans /encours
                const response = await fetch('/api/check-module-encours', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: sessionData.user.id,
                        moduleId: 'librespeed'
                    })
                });

                if (response.ok) {
                    updateStatus('module-status', 'success', 'Visible');
                    return true;
                } else {
                    updateStatus('module-status', 'error', 'Masqu√©');
                    return false;
                }
            } catch (error) {
                console.error('Erreur v√©rification module:', error);
                updateStatus('module-status', 'error', 'Erreur');
                return false;
            }
        }

        // Fonction pour v√©rifier l'acc√®s valide au module
        async function checkValidModuleAccess() {
            try {
                if (!sessionData?.user?.id) {
                    updateStatus('access-status', 'error', 'Pas de session');
                    return false;
                }

                // Simuler la v√©rification des tokens d'acc√®s
                const response = await fetch('/api/check-module-access', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: sessionData.user.id,
                        moduleId: 'librespeed'
                    })
                });

                if (response.ok) {
                    updateStatus('access-status', 'success', 'Valide');
                    return true;
                } else {
                    updateStatus('access-status', 'error', 'Expir√©');
                    return false;
                }
            } catch (error) {
                console.error('Erreur v√©rification acc√®s:', error);
                updateStatus('access-status', 'error', 'Erreur');
                return false;
            }
        }

        // Fonction pour v√©rifier l'origine de la requ√™te
        function checkOrigin() {
            const referer = document.referrer;
            const origin = window.location.origin;
            
            if (referer.includes('iahome.fr') || origin.includes('iahome.fr')) {
                updateStatus('origin-status', 'success', 'Autoris√©e');
                return true;
            } else {
                updateStatus('origin-status', 'error', 'Bloqu√©e');
                return false;
            }
        }

        // Fonction principale pour acc√©der √† LibreSpeed
        async function accessLibreSpeed() {
            if (isChecking) return;
            
            isChecking = true;
            const btn = document.getElementById('access-btn');
            const btnText = document.getElementById('btn-text');
            const loading = document.getElementById('loading');
            
            btn.disabled = true;
            btnText.style.display = 'none';
            loading.style.display = 'flex';
            
            try {
                // 1. V√©rifier la session utilisateur
                const hasSession = await checkUserSession();
                if (!hasSession) {
                    showMessage('error', 'Vous devez √™tre connect√© pour acc√©der √† LibreSpeed');
                    return;
                }

                // 2. V√©rifier si le module est visible dans /encours
                const isModuleVisible = await checkModuleInEncours();
                if (!isModuleVisible) {
                    showMessage('error', 'Le module LibreSpeed n\'est pas visible dans /encours');
                    return;
                }

                // 3. V√©rifier l'acc√®s valide au module
                const hasValidAccess = await checkValidModuleAccess();
                if (!hasValidAccess) {
                    showMessage('error', 'Votre acc√®s au module LibreSpeed a expir√© ou est invalide');
                    return;
                }

                // 4. V√©rifier l'origine de la requ√™te
                const isOriginValid = checkOrigin();
                if (!isOriginValid) {
                    showMessage('error', 'Acc√®s direct bloqu√© - veuillez passer par iahome.fr');
                    return;
                }

                // 5. Toutes les v√©rifications sont pass√©es
                showMessage('success', 'Acc√®s autoris√© ! Redirection vers LibreSpeed...');
                
                // Simuler l'incr√©mentation du compteur d'utilisation
                await incrementUsageCount();
                
                // Rediriger vers LibreSpeed
                setTimeout(() => {
                    window.location.href = 'https://librespeed.adamhome.fr';
                }, 2000);

            } catch (error) {
                console.error('Erreur lors de l\'acc√®s √† LibreSpeed:', error);
                showMessage('error', 'Une erreur est survenue lors de la v√©rification des acc√®s');
            } finally {
                isChecking = false;
                btn.disabled = false;
                btnText.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        // Fonction pour incr√©menter le compteur d'utilisation
        async function incrementUsageCount() {
            try {
                if (!sessionData?.user?.id) return;

                await fetch('/api/increment-usage', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: sessionData.user.id,
                        moduleId: 'librespeed'
                    })
                });
            } catch (error) {
                console.error('Erreur incr√©mentation compteur:', error);
            }
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Test Int√©gration LibreSpeed - Initialisation');
            
            // V√©rifier l'origine imm√©diatement
            checkOrigin();
            
            // V√©rifier la session
            await checkUserSession();
            
            // Si session valide, v√©rifier les autres conditions
            if (sessionData?.user?.id) {
                await checkModuleInEncours();
                await checkValidModuleAccess();
            }
        });
    </script>
</body>
</html>