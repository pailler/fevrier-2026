version: '3.8'

services:
  stirling-pdf:
    image: frooodle/s-pdf:latest
    container_name: stirling-pdf
    restart: unless-stopped
    ports:
      - "8080:8080"  # Port principal de Stirling-PDF
    environment:
      - DOCKER_ENABLE_SECURITY=false  # Désactiver la sécurité pour un accès sans authentification
      - DOCKER_ENABLE_UPDATE_CHECK=false  # Désactiver les vérifications de mise à jour
      - DOCKER_ENABLE_CORS=true  # Activer CORS pour l'intégration web
      - DOCKER_ENABLE_LOGGING=true  # Activer les logs
      - DOCKER_ENABLE_DEBUG=false  # Désactiver le mode debug en production
    volumes:
      - ./pdf-data:/usr/share/tesseract-ocr/4.00/tessdata  # Données OCR
      - ./pdf-uploads:/usr/share/tesseract-ocr/4.00/tessdata  # Dossier d'upload
      - ./pdf-temp:/tmp  # Dossier temporaire
    networks:
      - pdf-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stirling-pdf.rule=Host(`pdf.iahome.fr`)"
      - "traefik.http.routers.stirling-pdf.entrypoints=websecure"
      - "traefik.http.routers.stirling-pdf.tls=true"
      - "traefik.http.services.stirling-pdf.loadbalancer.server.port=8080"
      - "traefik.http.routers.stirling-pdf-http.rule=Host(`pdf.iahome.fr`)"
      - "traefik.http.routers.stirling-pdf-http.entrypoints=web"
      - "traefik.http.routers.stirling-pdf-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

networks:
  pdf-network:
    driver: bridge

volumes:
  pdf-data:
  pdf-uploads:
  pdf-temp:
