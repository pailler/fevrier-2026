<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Le Labo Num√©rique">
    <title>R√©servation √† l'accueil du Labo Num√©rique</title>
    <script>
        // Forcer le rechargement sans cache - m√©thode radicale
        const cssCacheBuster = '?v=' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_user_name_glow';
        document.write('<link rel="stylesheet" href="styles.css' + cssCacheBuster + '">');
    </script>
    <style>
        .backend-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4caf50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .backend-badge.offline {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Badge Backend -->
        <div class="backend-badge" id="backendBadge">üîå Backend</div>
        
        <!-- Header -->
        <header class="app-header">
            <div class="header-title-container">
                <h1>R√©servation √† l'accueil du Labo Num√©rique</h1>
                <h2 class="header-subtitle">Avec ta carte Geek, choisis ta r√©servation et plonge dans le jeu !</h2>
            </div>
            <div class="header-buttons">
                <button class="btn-rules" id="rulesBtn" title="Comment √ßa marche ?">‚ùì Comment √ßa marche ?</button>
                <button class="btn-active-games" id="activeGamesBtn" title="Voir les jeux en cours">üéÆ Jeu en cours</button>
            </div>
        </header>

        <!-- Liste des consoles -->
        <main class="consoles-list" id="consolesList">
            <!-- Les consoles seront g√©n√©r√©es dynamiquement par JavaScript -->
            <div style="text-align: center; padding: 40px; color: #666;">
                <p>Chargement des consoles...</p>
            </div>
        </main>

        <!-- R√®gles du bien jouer ensemble -->
        <footer class="rules-footer">
            <div class="rules-container">
                <div class="rules-header">
                    <h3>üåü R√®gles du bien jouer ensemble</h3>
                </div>
                <div class="rules-content">
                    <div class="rule-item">
                        <span class="rule-icon">üé´</span>
                        <span class="rule-text">Si tu n'as pas encore ta carte Geek, demande √† l'animateur du Labo.</span>
                    </div>
                    <div class="rule-item">
                        <span class="rule-icon">üë§</span>
                        <span class="rule-text">Utilise ton <strong>vrai pr√©nom (pas de pseudo)</strong> et le <strong>num√©ro de ta carte de Geek</strong>.</span>
                    </div>
                    <div class="rule-item">
                        <span class="rule-icon">‚úÖ</span>
                        <span class="rule-text">Valide ta r√©servation quand tu commences, sinon elle sera annul√©e apr√®s 5 minutes.</span>
                    </div>
                    <div class="rule-item">
                        <span class="rule-icon">üéÆ</span>
                        <span class="rule-text">Laisse la partie en cours se terminer.</span>
                    </div>
                    <div class="rule-item">
                        <span class="rule-icon">1Ô∏è‚É£</span>
                        <span class="rule-text"><strong>Tu ne peux faire qu'une r√©servation √† la fois</strong>.</span>
                    </div>
                    <div class="rule-item">
                        <span class="rule-icon">‚è∞</span>
                        <span class="rule-text"><strong>Tu es limit√© √† deux heures d'√©cran par jour</strong>.</span>
                    </div>
                    <div class="rule-item">
                        <span class="rule-icon">‚è±Ô∏è</span>
                        <span class="rule-text">Rends la console √† l'heure pr√©vue.</span>
                    </div>
                <div class="rule-item">
                    <span class="rule-icon">‚ùì</span>
                    <span class="rule-text">En cas de doute, demande de l'aide √† la personne pr√©sente au labo.</span>
                </div>
                <div class="rule-item">
                    <span class="rule-icon">üîê</span>
                    <span class="rule-text">L'animateur se r√©serve le droit de modifier ou d'annuler toute r√©servation en cours.</span>
                </div>
            </div>
            </div>
            <!-- Bouton Admin apr√®s les r√®gles -->
            <div style="text-align: center; padding: 20px 0 0 0;">
                <button class="btn-admin" id="adminBtn" title="Mode administrateur">üîê Admin</button>
            </div>
        </footer>

        <!-- Modal de r√©servation -->
        <div class="modal" id="reservationModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">R√©server une console</h2>
                    <button class="close-btn" id="closeModal">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="console-info" id="consoleInfo"></div>
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <strong>‚è±Ô∏è Dur√©e d'emprunt :</strong> Choisissez <strong>10 minutes</strong>, <strong>30 minutes</strong> ou <strong>1 heure</strong>. Les r√©servations non valid√©es √† l'heure de d√©but seront annul√©es 5 minutes apr√®s l'heure initiale de la r√©servation.
                    </div>
                    <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <strong>üîí Code PIN :</strong> Cr√©e un code PIN de 4 chiffres. Tu en auras besoin pour modifier ou supprimer ta r√©servation.
                    </div>
                    
                    <form id="reservationForm">
                        <div class="form-group">
                            <label for="userName">Ton pr√©nom :</label>
                            <input type="text" id="userName" required placeholder="Entre ton pr√©nom" style="width: 100%; margin-top: 8px;">
                            <div style="margin-top: 15px;">
                                <label for="scanNumber">üì∑ Num√©ro √† scanner :</label>
                                <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                                    <input type="text" id="scanNumber" required placeholder="Ex: 8012908" pattern="^8\d{6}$" maxlength="7" inputmode="numeric" style="font-size: 20px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; flex: 1; font-family: 'Courier New', monospace; text-align: center; letter-spacing: 2px;">
                                    <button type="button" id="scanBarcodeInFormBtn" class="btn btn-primary" style="padding: 12px 20px; white-space: nowrap; font-size: 16px; font-weight: bold;">
                                        üì∑ Scanner
                                    </button>
                                </div>
                                <small style="color: #666; font-size: 14px; display: block; margin-top: 5px;">Format requis : 7 chiffres commen√ßant par 8. Num√©ros autoris√©s : 8012908, 8012909, 8012910, 8012911</small>
                                <small id="scanNumberError" style="color: #f44336; font-size: 14px; display: none; margin-top: 5px;">‚ùå Format invalide : doit √™tre 7 chiffres commen√ßant par 8</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Dur√©e d'emprunt :</label>
                            <div class="duration-buttons-container" style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" class="btn btn-secondary duration-btn" data-duration="10" style="flex: 1;">‚è±Ô∏è 10 min</button>
                                <button type="button" class="btn btn-secondary duration-btn" data-duration="30" style="flex: 1;">‚è±Ô∏è 30 min</button>
                                <button type="button" class="btn btn-secondary duration-btn" data-duration="60" style="flex: 1;">‚è±Ô∏è 1 heure</button>
                            </div>
                            <div id="reservationTimeInfo" style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                                <p style="margin: 0; font-weight: bold; color: #1976d2;">üìÖ R√©servation</p>
                                <p style="margin: 5px 0 0 0; color: #555;" id="timeDetails">S√©lectionnez une dur√©e</p>
                            </div>
                            <input type="hidden" id="startDate" required>
                            <input type="hidden" id="endDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pin">üîí Code PIN (4 chiffres) :</label>
                            <input type="password" id="pin" required placeholder="1234" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" style="font-size: 24px; text-align: center; letter-spacing: 8px; font-family: 'Courier New', monospace;">
                            <small style="color: #666; font-size: 14px; display: block; margin-top: 5px;">Ce code te permettra de modifier ou supprimer ta r√©servation</small>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelBtn">Annuler</button>
                            <button type="submit" class="btn btn-primary" id="reserveBtn">R√©server</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de d√©tails/annulation -->
        <div class="modal" id="detailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="detailsModalTitle">D√©tails de la console</h2>
                    <button class="close-btn" id="closeDetailsModal">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="console-details" id="consoleDetails"></div>
                    <div class="reservation-details" id="reservationDetails"></div>
                    <div class="form-actions" id="detailsActions"></div>
                </div>
            </div>
        </div>

        <!-- Modal Admin -->
        <div class="modal" id="adminModal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 id="adminModalTitle">üîê Mode Administrateur</h2>
                    <button class="close-btn" id="closeAdminModal">√ó</button>
                </div>
                <div class="modal-body" id="adminModalBody">
                    <!-- Le contenu sera g√©n√©r√© dynamiquement -->
                </div>
            </div>
        </div>

        <!-- Modal R√®gles -->
        <div class="modal" id="rulesModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>üåü R√®gles du bien jouer ensemble</h2>
                    <button class="close-btn" id="closeRulesModal">√ó</button>
                </div>
                <div class="modal-body" id="rulesModalBody">
                    <div class="rules-content">
                        <div class="rule-item">
                            <span class="rule-icon">üé´</span>
                            <span class="rule-text">Si tu n'as pas encore ta carte Geek, demande √† l'animateur du Labo.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">üë§</span>
                            <span class="rule-text">Utilise ton <strong>vrai pr√©nom (pas de pseudo)</strong> et le <strong>num√©ro de ta carte de Geek</strong>.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">‚úÖ</span>
                            <span class="rule-text">Valide ta r√©servation quand tu commences, sinon elle sera annul√©e apr√®s 5 minutes.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">üéÆ</span>
                            <span class="rule-text">Laisse la partie en cours se terminer.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">1Ô∏è‚É£</span>
                            <span class="rule-text"><strong>Tu ne peux faire qu'une r√©servation √† la fois</strong>.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">‚è∞</span>
                            <span class="rule-text"><strong>Tu es limit√© √† deux heures d'√©cran par jour</strong>.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">‚è±Ô∏è</span>
                            <span class="rule-text">Rends la console √† l'heure pr√©vue.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">‚ùì</span>
                            <span class="rule-text">En cas de doute, demande de l'aide √† la personne pr√©sente au labo.</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">üîê</span>
                            <span class="rule-text">L'animateur se r√©serve le droit de modifier ou d'annuler toute r√©servation en cours.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de scan code-barres -->
        <div class="modal" id="barcodeModal">
            <div class="modal-content" style="max-width: 90%;">
                <div class="modal-header">
                    <h2>üì∑ Scanner un code-barres</h2>
                    <button class="close-btn" id="closeBarcodeModal">√ó</button>
                </div>
                <div class="modal-body">
                    <div id="barcodeScannerContainer" style="text-align: center;">
                        <video id="barcodeVideo" autoplay playsinline style="width: 100%; max-width: 640px; border-radius: 10px; background: #000;"></video>
                        <div style="margin-top: 20px;">
                            <p style="color: #666; font-size: 16px; font-weight: 500;">Positionnez le code-barres devant la cam√©ra</p>
                            <div id="barcodeStatus" style="margin-top: 15px; font-weight: bold; color: #4caf50; font-size: 18px; min-height: 30px;"></div>
                            <div id="barcodeDetectedNumber" style="margin-top: 10px; padding: 12px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; font-size: 24px; font-weight: bold; color: #2e7d32; font-family: 'Courier New', monospace; letter-spacing: 2px; display: none;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Num√©ro d√©tect√© :</div>
                                <div id="barcodeNumberValue" style="text-align: center;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast notifications -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // Forcer le rechargement sans cache - m√©thode radicale
        const jsCacheBuster = '?v=' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_console_icons';
        document.write('<script src="barcode-scanner.js' + jsCacheBuster + '"><\/script>');
        document.write('<script src="app-backend.js' + jsCacheBuster + '"><\/script>');
    </script>
    <script>
        // D√©tecter l'URL de l'API automatiquement
        function getApiUrl() {
            // Si on est sur le domaine public, utiliser l'URL compl√®te avec le m√™me domaine
            if (window.location.hostname.includes('regispailler.fr') || window.location.hostname.includes('iahome.fr')) {
                const protocol = window.location.protocol; // 'https:' ou 'http:'
                const hostname = window.location.hostname; // 'consoles.regispailler.fr'
                return `${protocol}//${hostname}/api/health`;
            }
            // Sinon, utiliser localhost pour le d√©veloppement local (backend sur port 5001)
            return 'http://localhost:5001/api/health';
        }
        
        // V√©rifier le statut du backend au chargement
        async function checkBackendStatus() {
            const badge = document.getElementById('backendBadge');
            if (!badge) return;
            
            try {
                const apiUrl = getApiUrl();
                console.log('üîç [checkBackendStatus] V√©rification backend:', apiUrl);
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    cache: 'no-cache',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    console.error(`‚ùå [checkBackendStatus] HTTP ${response.status}: ${response.statusText}`);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    badge.textContent = '‚úÖ Backend Connect√©';
                    badge.classList.remove('offline');
                } else {
                    throw new Error('Backend non disponible');
                }
            } catch (error) {
                console.error('‚ùå [checkBackendStatus] Erreur:', error);
                badge.textContent = '‚ùå Backend Offline';
                badge.classList.add('offline');
            }
        }
        
        // V√©rifier toutes les 10 secondes
        checkBackendStatus();
        setInterval(checkBackendStatus, 10000);
    </script>
</body>
</html>
